name: Notify Rune

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    # Skip notifications from the bot's own actions to avoid loops
    if: github.actor != 'runeaibot-bit'
    steps:
      - name: Notify Rune
        uses: actions/github-script@v7
        env:
          RUNE_WEBHOOK_URL: ${{ secrets.RUNE_WEBHOOK_URL }}
          RUNE_WEBHOOK_TOKEN: ${{ secrets.RUNE_WEBHOOK_TOKEN }}
        with:
          script: |
            const event = context.eventName;
            const action = context.payload.action;
            let msg = '';

            if (event === 'pull_request') {
              const pr = context.payload.pull_request;
              msg = `GitHub PR #${pr.number} ${action} by ${pr.user.login}: "${pr.title}" — ${pr.html_url}. Review the changes, run tests if needed, and comment on the PR.`;
            } else if (event === 'issues') {
              const issue = context.payload.issue;
              msg = `GitHub Issue #${issue.number} opened by ${issue.user.login}: "${issue.title}" — ${issue.html_url}. Review and comment if you can help.`;
            } else if (event === 'issue_comment') {
              const comment = context.payload.comment;
              const issueNum = context.payload.issue.number;
              const isPR = !!context.payload.issue.pull_request;
              const kind = isPR ? 'PR' : 'Issue';
              msg = `New comment by ${comment.user.login} on ${kind} #${issueNum} (${comment.html_url}): ${comment.body.substring(0, 500)}`;
            } else if (event === 'pull_request_review') {
              const review = context.payload.review;
              const prNum = context.payload.pull_request.number;
              msg = `PR #${prNum} review (${review.state}) by ${review.user.login}: ${review.html_url}`;
            }

            if (!msg) {
              console.log('No message to send, skipping.');
              return;
            }

            const resp = await fetch(`${process.env.RUNE_WEBHOOK_URL}/hooks/agent`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.RUNE_WEBHOOK_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: msg,
                name: 'GitHub',
                deliver: true,
                channel: 'telegram',
                to: '8599265092'
              })
            });
            const body = await resp.text();
            console.log(`Webhook response (${resp.status}): ${body}`);
            if (!resp.ok) {
              core.warning(`Webhook returned ${resp.status}: ${body}`);
            }
