# Vacuum ruleset for duck-demo OpenAPI spec.
#
# Extends vacuum's recommended OAS rules (42 built-in) plus all OWASP rules
# (23 security checks). Custom Go functions are registered programmatically;
# their rule entries appear under "Custom rules".
#
# Built-in rules use shorthand to override severity (or "off" to disable).
# Custom rules use full object format with given/then/resolved.

extends:
  - - "vacuum:oas"
    - "recommended"
  - - "vacuum:owasp"
    - "all"

rules:

  # ================================================================
  # Disable OAS2-only rules (this project uses OpenAPI 3.x)
  # ================================================================

  oas2-schema: off
  oas2-api-host: off
  oas2-api-schemes: off
  oas2-anyOf: off
  oas2-oneOf: off
  oas2-discriminator: off
  oas2-host-not-example: off
  oas2-host-trailing-slash: off
  oas2-operation-formData-consume-check: off
  oas2-operation-security-defined: off
  oas2-parameter-description: off
  oas2-unused-definition: off

  # ================================================================
  # Severity overrides for built-in rules
  # ================================================================

  # Errors — spec-breaking issues
  operation-tags: error
  operation-operationId: error
  operation-operationId-unique: error
  paths-kebab-case: error
  no-ambiguous-paths: error
  path-not-include-query: error
  duplicate-paths: error
  duplicated-entry-in-enum: error
  no-eval-in-markdown: error
  no-script-tags-in-markdown: error
  oas3-schema: error

  # Warnings — best-practice issues
  no-request-body: warn
  no-http-verbs-in-path: warn
  path-keys-no-trailing-slash: warn
  operation-success-response: warn
  typed-enum: warn
  no-unnecessary-combinator: warn
  oas3-no-$ref-siblings: warn
  oas3-api-servers: warn
  description-duplication: warn

  # Warnings — housekeeping
  oas3-unused-component: warn
  operation-description: info

  # Disable — intentionally off for this project
  camel-case-properties: off         # our API uses snake_case by convention
  migrate-zally-ignore: off          # not applicable

  # ================================================================
  # Custom rules using vacuum core functions
  # ================================================================

  # Operations must have a summary (for SDK/AI consumption)
  operation-summary:
    description: "Operations must have a summary"
    given: "$.paths[*][get,post,put,patch,delete]"
    severity: warn
    then:
      field: summary
      function: truthy

  # operationId must be lowerCamelCase (for SDK method naming)
  operation-id-camel-case:
    description: "operationId should be lowerCamelCase"
    given: "$.paths[*][get,post,put,patch,delete]"
    severity: warn
    then:
      field: operationId
      function: casing
      functionOptions:
        type: camel

  # ================================================================
  # Custom rules — backed by Go functions registered at runtime
  #
  # All custom rules use resolved: false so they see the raw YAML with
  # $ref nodes intact. Several rules (check-schema-ref, check-error-schema-ref,
  # check-pagination-*) inspect $ref values directly. The remaining rules
  # also use resolved: false for consistency — our YAML helpers handle
  # both inline and $ref'd parameters correctly.
  # ================================================================

  # Response + request schemas must use $ref (no inline anonymous objects)
  check-schema-ref:
    description: "Response and request body schemas must use $ref (no inline anonymous objects)"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkSchemaRef

  # Paginated GET endpoints must include MaxResults + PageToken params
  check-pagination-params:
    description: "Paginated GET endpoints must include MaxResults + PageToken params"
    given: "$"
    severity: error
    resolved: false
    then:
      function: checkPaginationParams

  # Paginated* schema structure validation
  check-paginated-schema:
    description: "Paginated schemas must have data (array) + next_page_token (string)"
    given: "$"
    severity: error
    resolved: false
    then:
      function: checkPaginatedSchema

  # POST-create endpoints should return 201
  check-post-create-status:
    description: "POST-create endpoints should return 201 (not 200)"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkPostCreateStatus

  # Mutating operations should include 403 response
  check-mutating-ops-403:
    description: "Mutating operations should include 403 response"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkMutatingOps403

  # GET resource paths should include 404 response
  check-get-resource-404:
    description: "GET operations on resource paths should include 404 response"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkGetResource404

  # Error responses should reference the standard Error schema
  check-error-schema-ref:
    description: "Error responses should reference the standard Error schema"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkErrorSchemaRef

  # DELETE operations should include 204 response
  check-delete-returns-204:
    description: "DELETE operations should include 204 response"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkDeleteReturns204

  # GET with pagination params should return Paginated* schema
  check-pagination-schema-match:
    description: "GET with pagination params should return a Paginated* schema"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkPaginationSchemaMatch

  # oneOf/anyOf must have discriminator for clean codegen
  check-discriminator-required:
    description: "Every oneOf/anyOf must have a discriminator object for clean codegen"
    given: "$"
    severity: warn
    resolved: false
    then:
      function: checkDiscriminatorRequired
