(()=>{(()=>{let u=document.querySelector("[data-reorder-url]"),f=u instanceof HTMLElement&&u.dataset.reorderUrl||"",c=()=>Array.from(document.querySelectorAll("[data-notebook-cell='true']")),k=()=>{let e=document.querySelector("input[name='csrf_token']");return e instanceof HTMLInputElement?e.value:""},m=()=>{let e=document.activeElement;return e?e.closest("[data-notebook-cell='true']"):null},L=e=>{if(!e)return;let t=e.querySelector("[data-cell-editor='true']");if(t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement){t.focus();let n=t.value.length;typeof t.setSelectionRange=="function"&&t.setSelectionRange(n,n)}},E=e=>{let t=c(),n=m();if(!n||t.length===0)return;let r=t.indexOf(n);if(r===-1)return;let o=t[r+e];o&&L(o)},l=e=>{c().forEach(a=>{a===e?a.classList.add("is-active-cell"):a.classList.remove("is-active-cell")});let t=e?.id||"";if(document.querySelectorAll("[data-outline-link='true']").forEach(a=>{(a.dataset.cellAnchor||"")===t?a.classList.add("is-active-outline-link"):a.classList.remove("is-active-outline-link")}),document.querySelectorAll(".notebook-insert-rail").forEach(a=>a.classList.remove("is-near-active")),!e)return;let o=e.previousElementSibling,s=e.nextElementSibling;o instanceof HTMLElement&&o.classList.contains("notebook-insert-rail")&&o.classList.add("is-near-active"),s instanceof HTMLElement&&s.classList.contains("notebook-insert-rail")&&s.classList.add("is-near-active")},T=e=>{if(!e)return null;let t=e.querySelector(".notebook-cell-form");return t instanceof HTMLFormElement?t:null},h=e=>{if(!e)return null;let t=e.querySelector("[data-cell-editor='true']");return t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement?t:null},w=e=>{let t=new URLSearchParams,n=new FormData(e);for(let[r,o]of n.entries())t.append(r,String(o));return t},M=(e,t)=>{let r=new DOMParser().parseFromString(t,"text/html"),o=e.getAttribute("id");if(!o)return;let s=r.querySelector(`#${o} [data-markdown-preview='true']`),a=e.querySelector("[data-markdown-preview='true']");s&&a&&(a.innerHTML=s.innerHTML)},d=async e=>{if(!e)return;let t=T(e);if(!t||t.dataset.dirty!=="true")return;let n=await fetch(t.action,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:w(t).toString()});if(!n.ok){window.location.reload();return}if(t.dataset.dirty="false",e.dataset.cellType==="markdown"){let r=await n.text();M(e,r)}},g=e=>{!e||e.dataset.cellType!=="markdown"||(e.classList.add("is-editing-markdown"),L(e))},p=e=>{if(!e||e.dataset.cellType!=="markdown")return;e.classList.remove("is-editing-markdown"),e.querySelector("[data-markdown-preview='true']")?.focus()};document.addEventListener("input",e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches("[data-cell-editor='true']"))return;let n=t.closest("[data-notebook-cell='true']"),r=T(n);r&&(r.dataset.dirty="true")}),document.addEventListener("focusout",e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches("[data-cell-editor='true']"))return;let n=t.closest("[data-notebook-cell='true']"),r=e.relatedTarget;r instanceof HTMLElement&&n?.contains(r)||d(n)}),document.addEventListener("focusin",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-notebook-cell='true']");n&&l(n)}),document.addEventListener("pointerdown",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-notebook-cell='true']");l(n),document.querySelectorAll("[data-cell-type='markdown'].is-editing-markdown").forEach(o=>{o.contains(t)||d(o).finally(()=>{p(o)})})}),document.addEventListener("dblclick",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-markdown-preview='true']");if(!n)return;let r=n.closest("[data-notebook-cell='true']");l(r),g(r)}),document.addEventListener("click",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-outline-link='true']");if(!n)return;let r=n.dataset.cellAnchor;if(!r)return;let o=document.getElementById(r);o instanceof HTMLElement&&(e.preventDefault(),l(o),o.scrollIntoView({behavior:"smooth",block:"start"}))}),document.addEventListener("keydown",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.matches("textarea, input, select"),r=m();if(e.key==="Escape"&&r?.dataset.cellType==="markdown"&&r.classList.contains("is-editing-markdown")){e.preventDefault(),d(r).finally(()=>{p(r)});return}if(e.key==="Enter"&&t.matches("[data-markdown-preview='true']")){e.preventDefault();let o=t.closest("[data-notebook-cell='true']");g(o);return}if(e.key==="Enter"&&e.shiftKey&&r){let o=r.querySelector("[data-run-cell='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click());return}if(!(!n||!r)){if(e.key==="j"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault(),E(1);return}if(e.key==="k"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault(),E(-1);return}if(e.key==="a"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){let o=r.querySelector("[data-add-above='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click());return}if(e.key==="b"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){let o=r.querySelector("[data-add-below='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click())}}});let y=window.location.hash?document.querySelector(window.location.hash):null;if(y?.matches("[data-notebook-cell='true']")&&l(y),!f)return;let i=null,H=async()=>{let e=c(),t=new URLSearchParams;e.forEach(o=>{let s=o.getAttribute("data-cell-id");s&&t.append("cell_ids",s)});let n=k();n&&t.set("csrf_token",n),(await fetch(f,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t.toString()})).ok||window.location.reload()};c().forEach(e=>{e.draggable=!0,e.addEventListener("dragstart",t=>{let n=t.target;if(!(n instanceof HTMLElement)||!n.closest("[data-drag-handle='true']")){t.preventDefault();return}i=e,e.classList.add("dragging"),t.dataTransfer&&(t.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),c().forEach(t=>t.classList.remove("drag-over")),i=null}),e.addEventListener("dragover",t=>{!i||i===e||(t.preventDefault(),e.classList.add("drag-over"))}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{if(!i||i===e)return;t.preventDefault(),e.classList.remove("drag-over");let n=e.parentElement;if(!n)return;let r=e.getBoundingClientRect();t.clientY>r.top+r.height/2?n.insertBefore(i,e.nextSibling):n.insertBefore(i,e),await H()})})})();})();
