(()=>{(()=>{let d=document.querySelector("[data-reorder-url]"),u=d instanceof HTMLElement&&d.dataset.reorderUrl||"",s=()=>Array.from(document.querySelectorAll("[data-notebook-cell='true']")),w=()=>{let e=document.querySelector("input[name='csrf_token']");return e instanceof HTMLInputElement?e.value:""},f=()=>{let e=document.activeElement;return e?e.closest("[data-notebook-cell='true']"):null},m=e=>{if(!e)return;let t=e.querySelector("[data-cell-editor='true']");if(t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement){t.focus();let r=t.value.length;typeof t.setSelectionRange=="function"&&t.setSelectionRange(r,r)}},L=e=>{let t=s(),r=f();if(!r||t.length===0)return;let n=t.indexOf(r);if(n===-1)return;let o=t[n+e];o&&m(o)},c=e=>{s().forEach(n=>{n===e?n.classList.add("is-active-cell"):n.classList.remove("is-active-cell")});let t=e?.id||"";document.querySelectorAll("[data-outline-link='true']").forEach(n=>{(n.dataset.cellAnchor||"")===t?n.classList.add("is-active-outline-link"):n.classList.remove("is-active-outline-link")})},E=e=>{if(!e)return null;let t=e.querySelector(".notebook-cell-form");return t instanceof HTMLFormElement?t:null},h=e=>{if(!e)return null;let t=e.querySelector("[data-cell-editor='true']");return t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement?t:null},k=e=>{let t=new URLSearchParams,r=new FormData(e);for(let[n,o]of r.entries())t.append(n,String(o));return t},M=(e,t)=>{let n=new DOMParser().parseFromString(t,"text/html"),o=e.getAttribute("id");if(!o)return;let i=n.querySelector(`#${o} [data-markdown-preview='true']`),y=e.querySelector("[data-markdown-preview='true']");i&&y&&(y.innerHTML=i.innerHTML)},l=async e=>{if(!e)return;let t=E(e);if(!t||t.dataset.dirty!=="true")return;let r=await fetch(t.action,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:k(t).toString()});if(!r.ok){window.location.reload();return}if(t.dataset.dirty="false",e.dataset.cellType==="markdown"){let n=await r.text();M(e,n)}},T=e=>{!e||e.dataset.cellType!=="markdown"||(e.classList.add("is-editing-markdown"),m(e))},g=e=>{if(!e||e.dataset.cellType!=="markdown")return;e.classList.remove("is-editing-markdown"),e.querySelector("[data-markdown-preview='true']")?.focus()};document.addEventListener("input",e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches("[data-cell-editor='true']"))return;let r=t.closest("[data-notebook-cell='true']"),n=E(r);n&&(n.dataset.dirty="true")}),document.addEventListener("focusout",e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches("[data-cell-editor='true']"))return;let r=t.closest("[data-notebook-cell='true']"),n=e.relatedTarget;n instanceof HTMLElement&&r?.contains(n)||l(r)}),document.addEventListener("focusin",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let r=t.closest("[data-notebook-cell='true']");r&&c(r)}),document.addEventListener("pointerdown",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let r=t.closest("[data-notebook-cell='true']");c(r),document.querySelectorAll("[data-cell-type='markdown'].is-editing-markdown").forEach(o=>{o.contains(t)||l(o).finally(()=>{g(o)})})}),document.addEventListener("dblclick",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let r=t.closest("[data-markdown-preview='true']");if(!r)return;let n=r.closest("[data-notebook-cell='true']");c(n),T(n)}),document.addEventListener("click",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let r=t.closest("[data-outline-link='true']");if(!r)return;let n=r.dataset.cellAnchor;if(!n)return;let o=document.getElementById(n);o instanceof HTMLElement&&(e.preventDefault(),c(o),o.scrollIntoView({behavior:"smooth",block:"start"}))}),document.addEventListener("keydown",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let r=t.matches("textarea, input, select"),n=f();if(e.key==="Escape"&&n?.dataset.cellType==="markdown"&&n.classList.contains("is-editing-markdown")){e.preventDefault(),l(n).finally(()=>{g(n)});return}if(e.key==="Enter"&&t.matches("[data-markdown-preview='true']")){e.preventDefault();let o=t.closest("[data-notebook-cell='true']");T(o);return}if(e.key==="Enter"&&e.shiftKey&&n){let o=n.querySelector("[data-run-cell='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click());return}if(!(!r||!n)){if(e.key==="j"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault(),L(1);return}if(e.key==="k"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault(),L(-1);return}if(e.key==="a"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){let o=n.querySelector("[data-add-above='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click());return}if(e.key==="b"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){let o=n.querySelector("[data-add-below='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click())}}});let p=window.location.hash?document.querySelector(window.location.hash):null;if(p?.matches("[data-notebook-cell='true']")&&c(p),!u)return;let a=null,H=async()=>{let e=s(),t=new URLSearchParams;e.forEach(o=>{let i=o.getAttribute("data-cell-id");i&&t.append("cell_ids",i)});let r=w();r&&t.set("csrf_token",r),(await fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t.toString()})).ok||window.location.reload()};s().forEach(e=>{e.draggable=!0,e.addEventListener("dragstart",t=>{let r=t.target;if(!(r instanceof HTMLElement)||!r.closest("[data-drag-handle='true']")){t.preventDefault();return}a=e,e.classList.add("dragging"),t.dataTransfer&&(t.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),s().forEach(t=>t.classList.remove("drag-over")),a=null}),e.addEventListener("dragover",t=>{!a||a===e||(t.preventDefault(),e.classList.add("drag-over"))}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{if(!a||a===e)return;t.preventDefault(),e.classList.remove("drag-over");let r=e.parentElement;if(!r)return;let n=e.getBoundingClientRect();t.clientY>n.top+n.height/2?r.insertBefore(a,e.nextSibling):r.insertBefore(a,e),await H()})})})();})();
