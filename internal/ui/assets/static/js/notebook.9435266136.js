(()=>{(()=>{let d=document.querySelector("[data-reorder-url]"),u=d instanceof HTMLElement&&d.dataset.reorderUrl||"",s=()=>Array.from(document.querySelectorAll("[data-notebook-cell='true']")),y=()=>{let e=document.querySelector("input[name='csrf_token']");return e instanceof HTMLInputElement?e.value:""},f=()=>{let e=document.activeElement;return e?e.closest("[data-notebook-cell='true']"):null},m=e=>{if(!e)return;let t=e.querySelector("[data-cell-editor='true']");if(t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement){t.focus();let n=t.value.length;typeof t.setSelectionRange=="function"&&t.setSelectionRange(n,n)}},L=e=>{let t=s(),n=f();if(!n||t.length===0)return;let r=t.indexOf(n);if(r===-1)return;let o=t[r+e];o&&m(o)},c=e=>{s().forEach(t=>{t===e?t.classList.add("is-active-cell"):t.classList.remove("is-active-cell")})},E=e=>{if(!e)return null;let t=e.querySelector(".notebook-cell-form");return t instanceof HTMLFormElement?t:null},H=e=>{if(!e)return null;let t=e.querySelector("[data-cell-editor='true']");return t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement?t:null},w=e=>{let t=new URLSearchParams,n=new FormData(e);for(let[r,o]of n.entries())t.append(r,String(o));return t},M=(e,t)=>{let r=new DOMParser().parseFromString(t,"text/html"),o=e.getAttribute("id");if(!o)return;let i=r.querySelector(`#${o} [data-markdown-preview='true']`),g=e.querySelector("[data-markdown-preview='true']");i&&g&&(g.innerHTML=i.innerHTML)},l=async e=>{if(!e)return;let t=E(e);if(!t||t.dataset.dirty!=="true")return;let n=await fetch(t.action,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:w(t).toString()});if(!n.ok){window.location.reload();return}if(t.dataset.dirty="false",e.dataset.cellType==="markdown"){let r=await n.text();M(e,r)}},T=e=>{!e||e.dataset.cellType!=="markdown"||(e.classList.add("is-editing-markdown"),m(e))},p=e=>{if(!e||e.dataset.cellType!=="markdown")return;e.classList.remove("is-editing-markdown"),e.querySelector("[data-markdown-preview='true']")?.focus()};if(document.addEventListener("input",e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches("[data-cell-editor='true']"))return;let n=t.closest("[data-notebook-cell='true']"),r=E(n);r&&(r.dataset.dirty="true")}),document.addEventListener("focusout",e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches("[data-cell-editor='true']"))return;let n=t.closest("[data-notebook-cell='true']"),r=e.relatedTarget;r instanceof HTMLElement&&n?.contains(r)||l(n)}),document.addEventListener("focusin",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-notebook-cell='true']");n&&c(n)}),document.addEventListener("pointerdown",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-notebook-cell='true']");c(n),document.querySelectorAll("[data-cell-type='markdown'].is-editing-markdown").forEach(o=>{o.contains(t)||l(o).finally(()=>{p(o)})})}),document.addEventListener("dblclick",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest("[data-markdown-preview='true']");if(!n)return;let r=n.closest("[data-notebook-cell='true']");c(r),T(r)}),document.addEventListener("keydown",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.matches("textarea, input, select"),r=f();if(e.key==="Escape"&&r?.dataset.cellType==="markdown"&&r.classList.contains("is-editing-markdown")){e.preventDefault(),l(r).finally(()=>{p(r)});return}if(e.key==="Enter"&&t.matches("[data-markdown-preview='true']")){e.preventDefault();let o=t.closest("[data-notebook-cell='true']");T(o);return}if(e.key==="Enter"&&e.shiftKey&&r){let o=r.querySelector("[data-run-cell='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click());return}if(!(!n||!r)){if(e.key==="j"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault(),L(1);return}if(e.key==="k"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault(),L(-1);return}if(e.key==="a"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){let o=r.querySelector("[data-add-above='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click());return}if(e.key==="b"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){let o=r.querySelector("[data-add-below='true']");o instanceof HTMLButtonElement&&(e.preventDefault(),o.click())}}}),!u)return;let a=null,k=async()=>{let e=s(),t=new URLSearchParams;e.forEach(o=>{let i=o.getAttribute("data-cell-id");i&&t.append("cell_ids",i)});let n=y();n&&t.set("csrf_token",n),(await fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t.toString()})).ok||window.location.reload()};s().forEach(e=>{e.draggable=!0,e.addEventListener("dragstart",t=>{let n=t.target;if(!(n instanceof HTMLElement)||!n.closest("[data-drag-handle='true']")){t.preventDefault();return}a=e,e.classList.add("dragging"),t.dataTransfer&&(t.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),s().forEach(t=>t.classList.remove("drag-over")),a=null}),e.addEventListener("dragover",t=>{!a||a===e||(t.preventDefault(),e.classList.add("drag-over"))}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{if(!a||a===e)return;t.preventDefault(),e.classList.remove("drag-over");let n=e.parentElement;if(!n)return;let r=e.getBoundingClientRect();t.clientY>r.top+r.height/2?n.insertBefore(a,e.nextSibling):n.insertBefore(a,e),await k()})})})();})();
