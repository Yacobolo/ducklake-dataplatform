paths:
  /compute-endpoints:
    get:
      operationId: listComputeEndpoints
      summary: List compute endpoints
      tags: [Compute]
      description: Returns a paginated list of compute endpoints.
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of compute endpoints
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/PaginatedComputeEndpoints'
              example:
                data:
                  - id: "550e8400-e29b-41d4-a716-446655440001"
                    external_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    name: "prod-endpoint"
                    url: "https://compute.example.com:8080"
                    type: REMOTE
                    status: ACTIVE
                    size: LARGE
                    max_memory_gb: 64
                    owner: "admin"
                    created_at: "2025-01-15T09:30:00Z"
                    updated_at: "2025-01-15T09:30:00Z"
                next_page_token: "eyJpZCI6MTB9"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
    post:
      operationId: createComputeEndpoint
      summary: Create a compute endpoint
      tags: [Compute]
      description: Creates a new compute endpoint. Requires MANAGE_COMPUTE on catalog.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/compute.yaml#/CreateComputeEndpointRequest'
            example:
              name: "prod-endpoint"
              url: "https://compute.example.com:8080"
              type: REMOTE
              size: LARGE
              max_memory_gb: 64
              auth_token: "dck_a1b2c3d4e5f6g7h8i9j0"
      responses:
        '201':
          description: Created compute endpoint
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/ComputeEndpoint'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                external_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                name: "prod-endpoint"
                url: "https://compute.example.com:8080"
                type: REMOTE
                status: ACTIVE
                size: LARGE
                max_memory_gb: 64
                owner: "admin"
                created_at: "2025-01-15T09:30:00Z"
                updated_at: "2025-01-15T09:30:00Z"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '409':
          $ref: '../schemas/responses.yaml#/responses/Conflict'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'

  /compute-endpoints/{endpointName}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/endpointName'
    get:
      operationId: getComputeEndpoint
      summary: Get a compute endpoint by name
      tags: [Compute]
      description: Retrieves the details of a specific compute endpoint identified by its name.
      responses:
        '200':
          description: Compute endpoint details
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/ComputeEndpoint'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                external_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                name: "prod-endpoint"
                url: "https://compute.example.com:8080"
                type: REMOTE
                status: ACTIVE
                size: LARGE
                max_memory_gb: 64
                owner: "admin"
                created_at: "2025-01-15T09:30:00Z"
                updated_at: "2025-01-15T09:30:00Z"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
    patch:
      operationId: updateComputeEndpoint
      summary: Update a compute endpoint
      tags: [Compute]
      description: Updates compute endpoint fields. Requires MANAGE_COMPUTE on catalog.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/compute.yaml#/UpdateComputeEndpointRequest'
            example:
              url: "https://compute-v2.example.com:8080"
              size: LARGE
              max_memory_gb: 128
              status: ACTIVE
      responses:
        '200':
          description: Updated compute endpoint
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/ComputeEndpoint'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                external_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                name: "prod-endpoint"
                url: "https://compute.example.com:8080"
                type: REMOTE
                status: ACTIVE
                size: LARGE
                max_memory_gb: 64
                owner: "admin"
                created_at: "2025-01-15T09:30:00Z"
                updated_at: "2025-01-15T09:30:00Z"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
    delete:
      operationId: deleteComputeEndpoint
      summary: Delete a compute endpoint
      tags: [Compute]
      description: Deletes a compute endpoint. Requires MANAGE_COMPUTE on catalog.
      responses:
        '204':
          description: Compute endpoint deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'

  /compute-endpoints/{endpointName}/assignments:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/endpointName'
    get:
      operationId: listComputeAssignments
      summary: List assignments for a compute endpoint
      tags: [Compute]
      description: Returns a paginated list of principal assignments for the specified compute endpoint.
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of compute assignments
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/PaginatedComputeAssignments'
              example:
                data:
                  - id: "550e8400-e29b-41d4-a716-446655440001"
                    principal_id: "550e8400-e29b-41d4-a716-446655440003"
                    principal_type: "user"
                    endpoint_id: "550e8400-e29b-41d4-a716-446655440001"
                    endpoint_name: "prod-endpoint"
                    is_default: true
                    fallback_local: false
                    created_at: "2025-01-15T09:30:00Z"
                next_page_token: "eyJpZCI6MTB9"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
    post:
      operationId: createComputeAssignment
      summary: Assign a principal to a compute endpoint
      tags: [Compute]
      description: Creates a compute assignment. Requires MANAGE_COMPUTE on catalog.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/compute.yaml#/CreateComputeAssignmentRequest'
            example:
              principal_id: "550e8400-e29b-41d4-a716-446655440003"
              principal_type: "user"
              is_default: true
              fallback_local: false
      responses:
        '201':
          description: Created compute assignment
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/ComputeAssignment'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                principal_id: "550e8400-e29b-41d4-a716-446655440003"
                principal_type: "user"
                endpoint_id: "550e8400-e29b-41d4-a716-446655440001"
                endpoint_name: "prod-endpoint"
                is_default: true
                fallback_local: false
                created_at: "2025-01-15T09:30:00Z"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '409':
          $ref: '../schemas/responses.yaml#/responses/Conflict'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'

  /compute-endpoints/{endpointName}/health:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/endpointName'
    get:
      operationId: getComputeEndpointHealth
      summary: Check health of a compute endpoint
      tags: [Compute]
      description: Proxies a health check to the remote compute agent. Requires MANAGE_COMPUTE on catalog.
      responses:
        '200':
          description: Health check result
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/compute.yaml#/ComputeEndpointHealth'
              example:
                status: "ok"
                uptime_seconds: 86400
                duckdb_version: "v1.1.3"
                memory_used_mb: 2048
                max_memory_gb: 64
                endpoint_name: "prod-endpoint"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '502':
          description: Agent unreachable
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/common.yaml#/Error'
              example:
                code: 502
                message: "Upstream compute agent is unreachable"

  /compute-endpoints/{endpointName}/assignments/{assignmentId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/endpointName'
      - $ref: '../schemas/responses.yaml#/parameters/assignmentId'
    delete:
      operationId: deleteComputeAssignment
      summary: Remove a compute assignment
      tags: [Compute]
      description: Removes a compute assignment. Requires MANAGE_COMPUTE on catalog.
      responses:
        '204':
          description: Assignment deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
