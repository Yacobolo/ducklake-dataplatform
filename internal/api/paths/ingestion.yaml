paths:
  /catalogs/{catalogName}/schemas/{schemaName}/tables/{tableName}/ingestion/upload-url:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/catalogName'
      - $ref: '../schemas/responses.yaml#/parameters/schemaName'
      - $ref: '../schemas/responses.yaml#/parameters/tableName'
    post:
      operationId: createUploadUrl
      summary: Get a presigned URL for uploading a Parquet file
      tags: [Ingestion]
      description: >
        Returns a presigned PUT URL that the client can use to upload a Parquet file
        directly to S3. The file can then be registered via the commit endpoint.
        Requires INSERT privilege on the target table.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/ingestion.yaml#/UploadUrlRequest'
            example:
              filename: "events-2025-01-15.parquet"
      responses:
        '200':
          description: Presigned upload URL
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/ingestion.yaml#/UploadUrlResponse'
              example:
                upload_url: "https://s3.amazonaws.com/acme-datalake/uploads/2025/01/data.parquet?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Expires=3600"
                s3_key: "uploads/2025/01/data.parquet"
                expires_at: "2025-01-15T10:30:00Z"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'

  /catalogs/{catalogName}/schemas/{schemaName}/tables/{tableName}/ingestion/commit:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/catalogName'
      - $ref: '../schemas/responses.yaml#/parameters/schemaName'
      - $ref: '../schemas/responses.yaml#/parameters/tableName'
    post:
      operationId: commitTableIngestion
      summary: Register uploaded Parquet files in DuckLake
      tags: [Ingestion]
      description: >
        Registers previously uploaded files (from upload-url) in the DuckLake catalog.
        DuckLake validates schema compatibility, extracts column statistics, and
        registers files atomically. Requires INSERT privilege on the target table.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/ingestion.yaml#/CommitIngestionRequest'
            example:
              s3_keys:
                - "uploads/2025/01/events-part1.parquet"
                - "uploads/2025/01/events-part2.parquet"
              options:
                allow_missing_columns: false
                ignore_extra_columns: true
      responses:
        '200':
          description: Ingestion result
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/ingestion.yaml#/IngestionResult'
              example:
                files_registered: 3
                files_skipped: 0
                schema: "main"
                table: "events"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'

  /catalogs/{catalogName}/schemas/{schemaName}/tables/{tableName}/ingestion/load:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/catalogName'
      - $ref: '../schemas/responses.yaml#/parameters/schemaName'
      - $ref: '../schemas/responses.yaml#/parameters/tableName'
    post:
      operationId: loadTableExternalFiles
      summary: Register existing S3 files in DuckLake
      tags: [Ingestion]
      description: >
        Registers existing S3 files or globs in the DuckLake catalog. Paths without
        an s3:// prefix are treated as relative to the lake data path. DuckLake validates
        schema compatibility, extracts column statistics, and registers files atomically.
        Requires INSERT privilege on the target table.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/ingestion.yaml#/LoadExternalRequest'
            example:
              paths:
                - "s3://acme-datalake/raw/events/2025/01/*.parquet"
              options:
                allow_missing_columns: false
                ignore_extra_columns: false
      responses:
        '200':
          description: Ingestion result
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/ingestion.yaml#/IngestionResult'
              example:
                files_registered: 3
                files_skipped: 0
                schema: "main"
                table: "events"
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
