paths:
  /principals:
    get:
      operationId: listPrincipals
      summary: List all principals
      description: Returns a paginated list of all principals (users and service accounts) in the system.
      tags: [Security]
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of principals
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedPrincipals'
              example:
                data:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  name: alice
                  type: user
                  is_admin: false
                  created_at: '2025-01-15T09:30:00Z'
                - id: "550e8400-e29b-41d4-a716-446655440002"
                  name: bob
                  type: user
                  is_admin: true
                  created_at: '2025-01-16T14:00:00Z'
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    post:
      operationId: createPrincipal
      summary: Create a principal
      description: Creates a new principal with the specified name and optional type. Returns the created principal with its generated identifier.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreatePrincipalRequest'
            example:
              name: alice
              type: user
              is_admin: false
      responses:
        '201':
          description: Created principal
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/Principal'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                name: alice
                type: user
                is_admin: false
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '409':
          $ref: '../schemas/responses.yaml#/responses/Conflict'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /principals/{principalId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/principalId'
    get:
      operationId: getPrincipal
      summary: Get principal by ID
      description: Retrieves the details of a specific principal by its unique identifier.
      tags: [Security]
      responses:
        '200':
          description: Principal details
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/Principal'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                name: alice
                type: user
                is_admin: false
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    delete:
      operationId: deletePrincipal
      summary: Delete a principal
      description: Permanently removes a principal from the system. Associated grants and group memberships are also removed.
      tags: [Security]
      responses:
        '204':
          description: Deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /principals/{principalId}/admin:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/principalId'
    put:
      operationId: updatePrincipalAdmin
      summary: Set or unset admin flag
      description: Updates the admin status of a principal. Only existing admins can promote or demote other principals.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/UpdatePrincipalAdminRequest'
            example:
              is_admin: true
      responses:
        '204':
          description: Updated
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /groups:
    get:
      operationId: listGroups
      summary: List all groups
      description: Returns a paginated list of all groups defined in the system.
      tags: [Security]
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of groups
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedGroups'
              example:
                data:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  name: engineering
                  description: Engineering team
                  created_at: '2025-01-15T09:30:00Z'
                - id: "550e8400-e29b-41d4-a716-446655440002"
                  name: data-science
                  description: Data science team
                  created_at: '2025-01-16T14:00:00Z'
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    post:
      operationId: createGroup
      summary: Create a group
      description: Creates a new group with the specified name. Returns the created group with its generated identifier.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreateGroupRequest'
            example:
              name: engineering
              description: Engineering team
      responses:
        '201':
          description: Created group
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/Group'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                name: engineering
                description: Engineering team
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '409':
          $ref: '../schemas/responses.yaml#/responses/Conflict'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /groups/{groupId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/groupId'
    get:
      operationId: getGroup
      summary: Get group by ID
      description: Retrieves the details of a specific group by its unique identifier.
      tags: [Security]
      responses:
        '200':
          description: Group details
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/Group'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                name: engineering
                description: Engineering team
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    delete:
      operationId: deleteGroup
      summary: Delete a group
      description: Permanently removes a group from the system. All memberships and associated grants are also removed.
      tags: [Security]
      responses:
        '204':
          description: Deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /groups/{groupId}/members:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/groupId'
    get:
      operationId: listGroupMembers
      summary: List group members
      description: Returns a paginated list of all members (users and nested groups) belonging to the specified group.
      tags: [Security]
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of members
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedGroupMembers'
              example:
                data:
                - group_id: "550e8400-e29b-41d4-a716-446655440001"
                  member_type: user
                  member_id: "550e8400-e29b-41d4-a716-446655440002"
                - group_id: "550e8400-e29b-41d4-a716-446655440001"
                  member_type: group
                  member_id: "550e8400-e29b-41d4-a716-446655440003"
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    post:
      operationId: createGroupMember
      summary: Add member to group
      description: Adds a user or nested group as a member of the specified group.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreateGroupMemberRequest'
            example:
              member_type: user
              member_id: "550e8400-e29b-41d4-a716-446655440002"
      responses:
        '204':
          description: Member added
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    delete:
      operationId: deleteGroupMember
      summary: Remove member from group
      description: Removes a specific user or nested group from the specified group.
      tags: [Security]
      parameters:
        - name: member_type
          in: query
          required: true
          description: Type of the group member (user or group).
          schema:
            type: string
            enum: [user, group]
        - name: member_id
          in: query
          required: true
          description: Identifier of the member to remove.
          schema:
            type: string
            pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            maxLength: 36
      responses:
        '204':
          description: Member removed
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /grants:
    get:
      operationId: listGrants
      summary: List grants
      description: Returns a paginated list of privilege grants, optionally filtered by principal or securable.
      tags: [Security]
      parameters:
        - name: principal_id
          in: query
          description: Filter by principal identifier.
          schema:
            type: string
            pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            maxLength: 36
        - name: principal_type
          in: query
          description: Filter by principal type.
          schema:
            type: string
            enum: [user, group]
        - name: securable_type
          in: query
          description: Filter by securable resource type.
          schema:
            type: string
            maxLength: 255
            pattern: '^\S+$'
        - name: securable_id
          in: query
          description: Filter by securable resource identifier.
          schema:
            type: string
            pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            maxLength: 36
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of grants
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedGrants'
              example:
                data:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  principal_id: "550e8400-e29b-41d4-a716-446655440002"
                  principal_type: user
                  securable_type: schema
                  securable_id: "550e8400-e29b-41d4-a716-446655440001"
                  privilege: USE_SCHEMA
                  granted_by: "550e8400-e29b-41d4-a716-446655440001"
                  granted_at: '2025-01-15T09:30:00Z'
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    post:
      operationId: createGrant
      summary: Grant a privilege
      description: Creates a new privilege grant for a principal on a securable resource. Returns the created grant.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreateGrantRequest'
            example:
              principal_id: "550e8400-e29b-41d4-a716-446655440002"
              principal_type: user
              securable_type: schema
              securable_id: "550e8400-e29b-41d4-a716-446655440001"
              privilege: USE_SCHEMA
      responses:
        '201':
          description: Granted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PrivilegeGrant'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                principal_id: "550e8400-e29b-41d4-a716-446655440002"
                principal_type: user
                securable_type: schema
                securable_id: "550e8400-e29b-41d4-a716-446655440001"
                privilege: USE_SCHEMA
                granted_by: "550e8400-e29b-41d4-a716-446655440001"
                granted_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '409':
          $ref: '../schemas/responses.yaml#/responses/Conflict'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /grants/{grantId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/grantId'
    delete:
      operationId: deleteGrant
      summary: Revoke a privilege
      description: Revokes a previously granted privilege by deleting the grant record.
      tags: [Security]
      responses:
        '204':
          description: Revoked
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /api-keys:
    get:
      operationId: listAPIKeys
      summary: List API keys for a principal
      description: Returns a paginated list of API keys associated with the specified principal. Raw key values are not included.
      tags: [Security]
      parameters:
        - name: principal_id
          in: query
          required: false
          description: Filter by principal identifier.
          schema:
            type: string
            pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            maxLength: 36
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of API keys (no raw key values)
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedAPIKeys'
              example:
                data:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  principal_id: "550e8400-e29b-41d4-a716-446655440002"
                  name: ci-pipeline-key
                  key_prefix: dk_live_abc1
                  expires_at: '2026-01-15T09:30:00Z'
                  created_at: '2025-01-15T09:30:00Z'
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    post:
      operationId: createAPIKey
      summary: Create a new API key
      description: Generates a new API key for the specified principal. The raw key value is returned only in this response and cannot be retrieved later.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreateAPIKeyRequest'
            example:
              principal_id: "550e8400-e29b-41d4-a716-446655440002"
              name: ci-pipeline-key
              expires_at: '2026-01-15T09:30:00Z'
      responses:
        '201':
          description: API key created (raw key shown only once)
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/CreateAPIKeyResponse'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                key: dk_live_abc123def456ghi789
                name: ci-pipeline-key
                key_prefix: dk_live_abc1
                expires_at: '2026-01-15T09:30:00Z'
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /api-keys/{apiKeyId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/apiKeyId'
    delete:
      operationId: deleteAPIKey
      summary: Delete an API key
      description: Permanently deletes an API key, immediately revoking access for any client using it.
      tags: [Security]
      responses:
        '204':
          description: Deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'

  /api-keys/cleanup:
    post:
      operationId: cleanupExpiredAPIKeys
      summary: Delete all expired API keys (admin only)
      description: Removes all API keys that have passed their expiration date. Only administrators can perform this operation.
      tags: [Security]
      responses:
        '200':
          description: Number of keys deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/CleanupAPIKeysResponse'
              example:
                deleted_count: 3
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /tables/{tableId}/row-filters:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/tableId'
    get:
      operationId: listRowFilters
      summary: List row filters for table
      description: Returns a paginated list of all row-level security filters defined for the specified table.
      tags: [Security]
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of filters
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedRowFilters'
              example:
                data:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  table_id: "550e8400-e29b-41d4-a716-446655440005"
                  filter_sql: region = 'us-east-1'
                  description: Restrict to US East region
                  created_at: '2025-01-15T09:30:00Z'
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
    post:
      operationId: createRowFilter
      summary: Create row filter
      description: Creates a new row-level security filter for the specified table. The filter expression defines which rows are visible.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreateRowFilterRequest'
            example:
              table_id: "550e8400-e29b-41d4-a716-446655440005"
              filter_sql: region = 'us-east-1'
              description: Restrict to US East region
      responses:
        '201':
          description: Created filter
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/RowFilter'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                table_id: "550e8400-e29b-41d4-a716-446655440005"
                filter_sql: region = 'us-east-1'
                description: Restrict to US East region
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /row-filters/{rowFilterId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/rowFilterId'
    delete:
      operationId: deleteRowFilter
      summary: Delete row filter
      description: Permanently removes a row-level security filter and all its principal bindings.
      tags: [Security]
      responses:
        '204':
          description: Deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /row-filters/{rowFilterId}/bindings:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/rowFilterId'
    post:
      operationId: bindRowFilter
      summary: Bind filter to principal
      description: Associates a row-level security filter with a principal, so that the filter is applied when the principal queries the table.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/RowFilterBindingRequest'
            example:
              principal_id: "550e8400-e29b-41d4-a716-446655440002"
              principal_type: user
      responses:
        '204':
          description: Bound
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    delete:
      operationId: unbindRowFilter
      summary: Unbind filter from principal
      description: Removes the association between a row-level security filter and a principal.
      tags: [Security]
      parameters:
        - name: principal_id
          in: query
          required: true
          description: Filter by principal identifier.
          schema:
            type: string
            pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            maxLength: 36
        - name: principal_type
          in: query
          required: true
          description: Filter by principal type.
          schema:
            type: string
            enum: [user, group]
      responses:
        '204':
          description: Unbound
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /tables/{tableId}/column-masks:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/tableId'
    get:
      operationId: listColumnMasks
      summary: List column masks
      description: Returns a paginated list of all column masking rules defined for the specified table.
      tags: [Security]
      parameters:
        - $ref: '../schemas/common.yaml#/parameters/MaxResults'
        - $ref: '../schemas/common.yaml#/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of masks
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/PaginatedColumnMasks'
              example:
                data:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  table_id: "550e8400-e29b-41d4-a716-446655440005"
                  column_name: email
                  mask_expression: '''***@'' || split_part(email, ''@'', 2)'
                  description: Mask email local part
                  created_at: '2025-01-15T09:30:00Z'
                next_page_token: eyJpZCI6MTB9
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    post:
      operationId: createColumnMask
      summary: Create column mask
      description: Creates a new column masking rule for the specified table. The mask expression defines how column values are transformed.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/CreateColumnMaskRequest'
            example:
              column_name: email
              mask_expression: '''***@'' || split_part(email, ''@'', 2)'
              description: Mask email local part
      responses:
        '201':
          description: Created mask
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
          content:
            application/json:
              schema:
                $ref: '../schemas/security.yaml#/ColumnMask'
              example:
                id: "550e8400-e29b-41d4-a716-446655440001"
                table_id: "550e8400-e29b-41d4-a716-446655440005"
                column_name: email
                mask_expression: '''***@'' || split_part(email, ''@'', 2)'
                description: Mask email local part
                created_at: '2025-01-15T09:30:00Z'
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /column-masks/{columnMaskId}:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/columnMaskId'
    delete:
      operationId: deleteColumnMask
      summary: Delete column mask
      description: Permanently removes a column masking rule and all its principal bindings.
      tags: [Security]
      responses:
        '204':
          description: Deleted
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'

  /column-masks/{columnMaskId}/bindings:
    parameters:
      - $ref: '../schemas/responses.yaml#/parameters/columnMaskId'
    post:
      operationId: bindColumnMask
      summary: Bind mask to principal
      description: Associates a column masking rule with a principal, so that the mask is applied when the principal queries the table.
      tags: [Security]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/security.yaml#/ColumnMaskBindingRequest'
            example:
              principal_id: "550e8400-e29b-41d4-a716-446655440002"
              principal_type: user
              see_original: false
      responses:
        '204':
          description: Bound
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
    delete:
      operationId: unbindColumnMask
      summary: Unbind mask from principal
      description: Removes the association between a column masking rule and a principal.
      tags: [Security]
      parameters:
        - name: principal_id
          in: query
          required: true
          description: Filter by principal identifier.
          schema:
            type: string
            pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
            maxLength: 36
        - name: principal_type
          in: query
          required: true
          description: Filter by principal type.
          schema:
            type: string
            enum: [user, group]
      responses:
        '204':
          description: Unbound
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: integer
                minimum: 1
                maximum: 1000000
                format: int32
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: integer
                minimum: 0
                maximum: 1000000
                format: int32
            X-RateLimit-Reset:
              description: UTC epoch seconds when the rate limit resets.
              schema:
                type: integer
                minimum: 0
                maximum: 4102444800
                format: int64
        '400':
          $ref: '../schemas/responses.yaml#/responses/BadRequest'
        '403':
          $ref: '../schemas/responses.yaml#/responses/Forbidden'
        '404':
          $ref: '../schemas/responses.yaml#/responses/NotFound'
        '429':
          $ref: '../schemas/responses.yaml#/responses/RateLimitExceeded'
        '500':
          $ref: '../schemas/responses.yaml#/responses/InternalError'
        '401':
          $ref: '../schemas/responses.yaml#/responses/Unauthorized'
