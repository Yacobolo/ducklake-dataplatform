openapi: "3.0.3"
info:
  title: DuckDB Data Platform API
  version: "2.0.0"
  description: |
    HTTP API for the DuckDB data platform with RBAC, RLS, column masking,
    and Unity Catalog-compatible catalog management.

servers:
  - url: /v1

security:
  - BearerAuth: []
  - ApiKeyAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    MaxResults:
      name: max_results
      in: query
      description: Maximum number of results to return per page.
      required: false
      schema:
        type: integer
        default: 100
        maximum: 1000
    PageToken:
      name: page_token
      in: query
      description: Opaque pagination token from a previous response.
      required: false
      schema:
        type: string

  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: integer
        message:
          type: string

    # --- Query ---
    QueryRequest:
      type: object
      required: [sql]
      properties:
        sql:
          type: string

    QueryResult:
      type: object
      properties:
        columns:
          type: array
          items:
            type: string
        rows:
          type: array
          items:
            type: array
            items: {}
        row_count:
          type: integer

    # --- Principals ---
    Principal:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        type:
          type: string
        is_admin:
          type: boolean
        created_at:
          type: string
          format: date-time

    CreatePrincipalRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        type:
          type: string
          default: user
        is_admin:
          type: boolean
          default: false

    SetAdminRequest:
      type: object
      required: [is_admin]
      properties:
        is_admin:
          type: boolean

    PaginatedPrincipals:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Principal'
        next_page_token:
          type: string

    # --- Groups ---
    Group:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time

    CreateGroupRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string

    GroupMember:
      type: object
      properties:
        group_id:
          type: integer
          format: int64
        member_type:
          type: string
        member_id:
          type: integer
          format: int64

    AddGroupMemberRequest:
      type: object
      required: [member_type, member_id]
      properties:
        member_type:
          type: string
        member_id:
          type: integer
          format: int64

    PaginatedGroups:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Group'
        next_page_token:
          type: string

    PaginatedGroupMembers:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/GroupMember'
        next_page_token:
          type: string

    # --- Grants ---
    PrivilegeGrant:
      type: object
      properties:
        id:
          type: integer
          format: int64
        principal_id:
          type: integer
          format: int64
        principal_type:
          type: string
        securable_type:
          type: string
        securable_id:
          type: integer
          format: int64
        privilege:
          type: string
        granted_by:
          type: integer
          format: int64
          nullable: true
        granted_at:
          type: string
          format: date-time

    GrantRequest:
      type: object
      required: [principal_id, principal_type, securable_type, securable_id, privilege]
      properties:
        principal_id:
          type: integer
          format: int64
        principal_type:
          type: string
        securable_type:
          type: string
        securable_id:
          type: integer
          format: int64
        privilege:
          type: string

    RevokeRequest:
      type: object
      required: [principal_id, principal_type, securable_type, securable_id, privilege]
      properties:
        principal_id:
          type: integer
          format: int64
        principal_type:
          type: string
        securable_type:
          type: string
        securable_id:
          type: integer
          format: int64
        privilege:
          type: string

    PaginatedGrants:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/PrivilegeGrant'
        next_page_token:
          type: string

    # --- Row Filters ---
    RowFilter:
      type: object
      properties:
        id:
          type: integer
          format: int64
        table_id:
          type: integer
          format: int64
        filter_sql:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time

    CreateRowFilterRequest:
      type: object
      required: [filter_sql]
      properties:
        filter_sql:
          type: string
        description:
          type: string

    BindingRequest:
      type: object
      required: [principal_id, principal_type]
      properties:
        principal_id:
          type: integer
          format: int64
        principal_type:
          type: string

    PaginatedRowFilters:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/RowFilter'
        next_page_token:
          type: string

    # --- Column Masks ---
    ColumnMask:
      type: object
      properties:
        id:
          type: integer
          format: int64
        table_id:
          type: integer
          format: int64
        column_name:
          type: string
        mask_expression:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time

    CreateColumnMaskRequest:
      type: object
      required: [column_name, mask_expression]
      properties:
        column_name:
          type: string
        mask_expression:
          type: string
        description:
          type: string

    ColumnMaskBindingRequest:
      type: object
      required: [principal_id, principal_type]
      properties:
        principal_id:
          type: integer
          format: int64
        principal_type:
          type: string
        see_original:
          type: boolean
          default: false

    PaginatedColumnMasks:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ColumnMask'
        next_page_token:
          type: string

    # --- Legacy Introspection (deprecated) ---
    Schema:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string

    Table:
      type: object
      properties:
        id:
          type: integer
          format: int64
        schema_id:
          type: integer
          format: int64
        name:
          type: string

    Column:
      type: object
      properties:
        id:
          type: integer
          format: int64
        table_id:
          type: integer
          format: int64
        name:
          type: string
        type:
          type: string

    PaginatedSchemas:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Schema'
        next_page_token:
          type: string

    PaginatedTables:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Table'
        next_page_token:
          type: string

    PaginatedColumns:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Column'
        next_page_token:
          type: string

    # --- Audit ---
    AuditEntry:
      type: object
      properties:
        id:
          type: integer
          format: int64
        principal_name:
          type: string
        action:
          type: string
        statement_type:
          type: string
          nullable: true
        original_sql:
          type: string
          nullable: true
        rewritten_sql:
          type: string
          nullable: true
        tables_accessed:
          type: array
          items:
            type: string
        status:
          type: string
        error_message:
          type: string
          nullable: true
        duration_ms:
          type: integer
          format: int64
          nullable: true
        created_at:
          type: string
          format: date-time

    PaginatedAuditLogs:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntry'
        next_page_token:
          type: string

    # --- Manifest ---
    ManifestRequest:
      type: object
      required: [table]
      properties:
        table:
          type: string
        schema:
          type: string
          default: main

    ManifestColumn:
      type: object
      properties:
        name:
          type: string
        type:
          type: string

    ManifestResponse:
      type: object
      properties:
        table:
          type: string
        schema:
          type: string
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ManifestColumn'
        files:
          type: array
          items:
            type: string
        row_filters:
          type: array
          items:
            type: string
        column_masks:
          type: object
          additionalProperties:
            type: string
        expires_at:
          type: string
          format: date-time

    # --- Catalog Management ---
    CatalogInfo:
      type: object
      properties:
        name:
          type: string
        comment:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SchemaDetail:
      type: object
      properties:
        schema_id:
          type: integer
          format: int64
        name:
          type: string
        catalog_name:
          type: string
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string
        owner:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        deleted_at:
          type: string
          format: date-time
          nullable: true

    CreateSchemaRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string

    UpdateSchemaRequest:
      type: object
      properties:
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string

    UpdateTableRequest:
      type: object
      properties:
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string
        owner:
          type: string

    UpdateCatalogRequest:
      type: object
      properties:
        comment:
          type: string

    PaginatedSchemaDetails:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SchemaDetail'
        next_page_token:
          type: string

    TableDetail:
      type: object
      properties:
        table_id:
          type: integer
          format: int64
        name:
          type: string
        schema_name:
          type: string
        catalog_name:
          type: string
        table_type:
          type: string
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ColumnDetail'
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string
        owner:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        statistics:
          $ref: '#/components/schemas/TableStatistics'
        deleted_at:
          type: string
          format: date-time
          nullable: true

    ColumnDetail:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        position:
          type: integer
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string

    CreateTableApiRequest:
      type: object
      required: [name, columns]
      properties:
        name:
          type: string
        columns:
          type: array
          items:
            $ref: '#/components/schemas/CreateColumnDef'
        comment:
          type: string

    CreateColumnDef:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
        type:
          type: string

    UpdateColumnRequest:
      type: object
      properties:
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string

    PaginatedTableDetails:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TableDetail'
        next_page_token:
          type: string

    PaginatedColumnDetails:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ColumnDetail'
        next_page_token:
          type: string

    TableStatistics:
      type: object
      properties:
        row_count:
          type: integer
          format: int64
          nullable: true
        size_bytes:
          type: integer
          format: int64
          nullable: true
        column_count:
          type: integer
          format: int64
          nullable: true
        last_profiled_at:
          type: string
          format: date-time
          nullable: true
        profiled_by:
          type: string

    MetastoreSummary:
      type: object
      properties:
        catalog_name:
          type: string
        metastore_type:
          type: string
        storage_backend:
          type: string
        data_path:
          type: string
        schema_count:
          type: integer
          format: int64
        table_count:
          type: integer
          format: int64

    # --- Query History ---
    QueryHistoryEntry:
      type: object
      properties:
        id:
          type: integer
          format: int64
        principal_name:
          type: string
        original_sql:
          type: string
          nullable: true
        rewritten_sql:
          type: string
          nullable: true
        statement_type:
          type: string
          nullable: true
        tables_accessed:
          type: array
          items:
            type: string
        status:
          type: string
        error_message:
          type: string
          nullable: true
        duration_ms:
          type: integer
          format: int64
          nullable: true
        rows_returned:
          type: integer
          format: int64
          nullable: true
        created_at:
          type: string
          format: date-time

    PaginatedQueryHistory:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/QueryHistoryEntry'
        next_page_token:
          type: string

    # --- Search ---
    SearchResult:
      type: object
      properties:
        type:
          type: string
          description: "Object type: schema, table, or column"
        name:
          type: string
        schema_name:
          type: string
          nullable: true
        table_name:
          type: string
          nullable: true
        comment:
          type: string
          nullable: true
        match_field:
          type: string
          description: "Field that matched: name, comment, property, or tag"

    PaginatedSearchResults:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SearchResult'
        next_page_token:
          type: string

    # --- Lineage ---
    LineageEdge:
      type: object
      properties:
        id:
          type: integer
          format: int64
        source_table:
          type: string
        target_table:
          type: string
          nullable: true
        edge_type:
          type: string
          description: "Edge type: READ, WRITE, READ_WRITE"
        principal_name:
          type: string
        created_at:
          type: string
          format: date-time

    LineageNode:
      type: object
      properties:
        table_name:
          type: string
        upstream:
          type: array
          items:
            $ref: '#/components/schemas/LineageEdge'
        downstream:
          type: array
          items:
            $ref: '#/components/schemas/LineageEdge'

    PaginatedLineageEdges:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LineageEdge'
        next_page_token:
          type: string

    PurgeLineageRequest:
      type: object
      required: [older_than_days]
      properties:
        older_than_days:
          type: integer
          description: Delete lineage edges older than this many days.

    PurgeLineageResponse:
      type: object
      properties:
        deleted_count:
          type: integer
          format: int64

    # --- Tags ---
    Tag:
      type: object
      properties:
        id:
          type: integer
          format: int64
        key:
          type: string
        value:
          type: string
          nullable: true
        created_by:
          type: string
        created_at:
          type: string
          format: date-time

    CreateTagRequest:
      type: object
      required: [key]
      properties:
        key:
          type: string
        value:
          type: string

    TagAssignment:
      type: object
      properties:
        id:
          type: integer
          format: int64
        tag_id:
          type: integer
          format: int64
        securable_type:
          type: string
        securable_id:
          type: integer
          format: int64
        column_name:
          type: string
          nullable: true
        assigned_by:
          type: string
        assigned_at:
          type: string
          format: date-time

    CreateTagAssignmentRequest:
      type: object
      required: [securable_type, securable_id]
      properties:
        securable_type:
          type: string
        securable_id:
          type: integer
          format: int64
        column_name:
          type: string

    PaginatedTags:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        next_page_token:
          type: string

    # --- Views ---
    ViewDetail:
      type: object
      properties:
        id:
          type: integer
          format: int64
        schema_id:
          type: integer
          format: int64
        schema_name:
          type: string
        catalog_name:
          type: string
        name:
          type: string
        view_definition:
          type: string
        comment:
          type: string
          nullable: true
        properties:
          type: object
          additionalProperties:
            type: string
        owner:
          type: string
        source_tables:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateViewRequest:
      type: object
      required: [name, view_definition]
      properties:
        name:
          type: string
        view_definition:
          type: string
        comment:
          type: string

    UpdateViewRequest:
      type: object
      properties:
        comment:
          type: string
        properties:
          type: object
          additionalProperties:
            type: string
        view_definition:
          type: string

    PaginatedViewDetails:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ViewDetail'
        next_page_token:
          type: string

    # --- Ingestion ---
    UploadUrlRequest:
      type: object
      properties:
        filename:
          type: string
          description: Optional filename hint for the uploaded file.

    UploadUrlResponse:
      type: object
      properties:
        upload_url:
          type: string
          description: Presigned PUT URL for uploading the Parquet file.
        s3_key:
          type: string
          description: The S3 key where the file will be stored.
        expires_at:
          type: string
          format: date-time
          description: When the presigned URL expires.

    IngestionOptions:
      type: object
      properties:
        allow_missing_columns:
          type: boolean
          default: false
          description: Allow columns in the table that are missing from the Parquet file.
        ignore_extra_columns:
          type: boolean
          default: false
          description: Ignore columns in the Parquet file not present in the table.

    CommitIngestionRequest:
      type: object
      required: [s3_keys]
      properties:
        s3_keys:
          type: array
          items:
            type: string
          description: S3 keys returned from upload-url to register.
        options:
          $ref: '#/components/schemas/IngestionOptions'

    LoadExternalRequest:
      type: object
      required: [paths]
      properties:
        paths:
          type: array
          items:
            type: string
          description: S3 paths or globs to register.
        options:
          $ref: '#/components/schemas/IngestionOptions'

    IngestionResult:
      type: object
      properties:
        files_registered:
          type: integer
          description: Number of files successfully registered.
        files_skipped:
          type: integer
          description: Number of files skipped (e.g., empty files).
        schema:
          type: string
        table:
          type: string

paths:
  # === Query ===
  /query:
    post:
      operationId: executeQuery
      summary: Execute SQL as authenticated principal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Query result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResult'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # === Principals ===
  /principals:
    get:
      operationId: listPrincipals
      summary: List all principals
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of principals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedPrincipals'
    post:
      operationId: createPrincipal
      summary: Create a principal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePrincipalRequest'
      responses:
        '201':
          description: Created principal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Principal'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /principals/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: getPrincipal
      summary: Get principal by ID
      responses:
        '200':
          description: Principal details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Principal'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      operationId: deletePrincipal
      summary: Delete a principal
      responses:
        '204':
          description: Deleted
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /principals/{id}/admin:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    put:
      operationId: setAdmin
      summary: Set or unset admin flag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetAdminRequest'
      responses:
        '204':
          description: Updated
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # === Groups ===
  /groups:
    get:
      operationId: listGroups
      summary: List all groups
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of groups
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedGroups'
    post:
      operationId: createGroup
      summary: Create a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGroupRequest'
      responses:
        '201':
          description: Created group
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'

  /groups/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: getGroup
      summary: Get group by ID
      responses:
        '200':
          description: Group details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      operationId: deleteGroup
      summary: Delete a group
      responses:
        '204':
          description: Deleted

  /groups/{id}/members:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: listGroupMembers
      summary: List group members
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedGroupMembers'
    post:
      operationId: addGroupMember
      summary: Add member to group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddGroupMemberRequest'
      responses:
        '204':
          description: Member added
    delete:
      operationId: removeGroupMember
      summary: Remove member from group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddGroupMemberRequest'
      responses:
        '204':
          description: Member removed

  # === Grants ===
  /grants:
    get:
      operationId: listGrants
      summary: List grants
      parameters:
        - name: principal_id
          in: query
          schema:
            type: integer
            format: int64
        - name: principal_type
          in: query
          schema:
            type: string
        - name: securable_type
          in: query
          schema:
            type: string
        - name: securable_id
          in: query
          schema:
            type: integer
            format: int64
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of grants
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedGrants'
    post:
      operationId: grantPrivilege
      summary: Grant a privilege
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GrantRequest'
      responses:
        '201':
          description: Granted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivilegeGrant'
    delete:
      operationId: revokePrivilege
      summary: Revoke a privilege
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevokeRequest'
      responses:
        '204':
          description: Revoked

  # === Row Filters ===
  /tables/{tableId}/row-filters:
    parameters:
      - name: tableId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: listRowFilters
      summary: List row filters for table
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of filters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedRowFilters'
    post:
      operationId: createRowFilter
      summary: Create row filter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRowFilterRequest'
      responses:
        '201':
          description: Created filter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RowFilter'

  /row-filters/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    delete:
      operationId: deleteRowFilter
      summary: Delete row filter
      responses:
        '204':
          description: Deleted

  /row-filters/{id}/bindings:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    post:
      operationId: bindRowFilter
      summary: Bind filter to principal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BindingRequest'
      responses:
        '204':
          description: Bound
    delete:
      operationId: unbindRowFilter
      summary: Unbind filter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BindingRequest'
      responses:
        '204':
          description: Unbound

  # === Column Masks ===
  /tables/{tableId}/column-masks:
    parameters:
      - name: tableId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: listColumnMasks
      summary: List column masks
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of masks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedColumnMasks'
    post:
      operationId: createColumnMask
      summary: Create column mask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateColumnMaskRequest'
      responses:
        '201':
          description: Created mask
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ColumnMask'

  /column-masks/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    delete:
      operationId: deleteColumnMask
      summary: Delete column mask
      responses:
        '204':
          description: Deleted

  /column-masks/{id}/bindings:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    post:
      operationId: bindColumnMask
      summary: Bind mask to principal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ColumnMaskBindingRequest'
      responses:
        '204':
          description: Bound
    delete:
      operationId: unbindColumnMask
      summary: Unbind mask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BindingRequest'
      responses:
        '204':
          description: Unbound

  # === Legacy Introspection (deprecated) ===
  /schemas:
    get:
      operationId: listSchemas
      summary: List DuckLake schemas (deprecated, use /catalog/schemas)
      deprecated: true
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of schemas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedSchemas'

  /schemas/{id}/tables:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: listTables
      summary: List tables in schema (deprecated, use /catalog/schemas/{name}/tables)
      deprecated: true
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of tables
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTables'

  /tables/{id}/columns:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      operationId: listColumns
      summary: List columns in table (deprecated, use /catalog/schemas/{name}/tables/{name}/columns)
      deprecated: true
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of columns
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedColumns'

  # === Manifest ===
  /manifest:
    post:
      operationId: getManifest
      summary: Get table manifest with presigned URLs and security policies
      description: >
        Returns presigned S3 URLs for the Parquet files backing a table,
        along with RLS row filters and column masks for the authenticated
        principal. Used by the duck_access DuckDB extension for secure
        client-side querying.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManifestRequest'
      responses:
        '200':
          description: Manifest with presigned URLs and security policies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Table not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # === Audit Logs ===
  /audit-logs:
    get:
      operationId: listAuditLogs
      summary: Query audit logs
      parameters:
        - name: principal_name
          in: query
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated audit log entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedAuditLogs'

  # === Catalog Management ===
  /catalog:
    get:
      operationId: getCatalog
      summary: Get catalog info
      description: Returns information about the single DuckLake catalog.
      responses:
        '200':
          description: Catalog information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogInfo'
    patch:
      operationId: updateCatalog
      summary: Update catalog metadata
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCatalogRequest'
      responses:
        '200':
          description: Updated catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogInfo'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas:
    get:
      operationId: listCatalogSchemas
      summary: List schemas in the catalog
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of schemas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedSchemaDetails'
    post:
      operationId: createSchema
      summary: Create a new schema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSchemaRequest'
      responses:
        '201':
          description: Schema created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaDetail'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Schema already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getSchemaByName
      summary: Get a schema by name
      responses:
        '200':
          description: Schema details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaDetail'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      operationId: updateSchemaMetadata
      summary: Update schema metadata (comment, properties)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSchemaRequest'
      responses:
        '200':
          description: Updated schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaDetail'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      operationId: deleteSchema
      summary: Delete a schema
      parameters:
        - name: force
          in: query
          description: Force deletion even if the schema contains tables.
          required: false
          schema:
            type: boolean
      responses:
        '204':
          description: Schema deleted
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: listCatalogTables
      summary: List tables in a schema
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of tables
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTableDetails'
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      operationId: createCatalogTable
      summary: Create a new table in a schema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTableApiRequest'
      responses:
        '201':
          description: Table created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableDetail'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Table already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables/{tableName}:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getTableByName
      summary: Get a table by name
      responses:
        '200':
          description: Table details including columns
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableDetail'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      operationId: updateTableMetadata
      summary: Update table metadata (comment, properties, owner)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTableRequest'
      responses:
        '200':
          description: Updated table
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableDetail'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      operationId: dropTable
      summary: Delete a table
      responses:
        '204':
          description: Table deleted
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables/{tableName}/columns:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: listTableColumns
      summary: List columns of a table
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of columns
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedColumnDetails'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables/{tableName}/columns/{columnName}:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
      - name: columnName
        in: path
        required: true
        schema:
          type: string
    patch:
      operationId: updateColumnMetadata
      summary: Update column metadata (comment, properties)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateColumnRequest'
      responses:
        '200':
          description: Updated column
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ColumnDetail'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables/{tableName}/profile:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    post:
      operationId: profileTable
      summary: Profile a table to collect statistics
      description: Runs profiling queries and stores statistics (row count, column count, size).
      responses:
        '200':
          description: Table statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableStatistics'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # === Metastore ===
  /metastore/summary:
    get:
      operationId: getMetastoreSummary
      summary: Get metastore summary
      description: Returns high-level information about the DuckLake metastore.
      responses:
        '200':
          description: Metastore summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetastoreSummary'

  # === Query History ===
  /query-history:
    get:
      operationId: listQueryHistory
      summary: List query execution history
      parameters:
        - name: principal_name
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated query history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedQueryHistory'

  # === Search ===
  /search:
    get:
      operationId: searchCatalog
      summary: Search catalog objects
      description: Full-text search across schemas, tables, and columns.
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
        - name: type
          in: query
          description: "Filter by object type: schema, table, or column"
          schema:
            type: string
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedSearchResults'

  # === Lineage ===
  /lineage/tables/{schemaName}/{tableName}:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getTableLineage
      summary: Get full lineage for a table
      description: Returns both upstream and downstream lineage edges for a table.
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Table lineage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LineageNode'

  /lineage/tables/{schemaName}/{tableName}/upstream:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getUpstreamLineage
      summary: Get upstream lineage for a table
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Upstream lineage edges
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedLineageEdges'

  /lineage/tables/{schemaName}/{tableName}/downstream:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getDownstreamLineage
      summary: Get downstream lineage for a table
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Downstream lineage edges
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedLineageEdges'

  /lineage/edges/{edgeId}:
    parameters:
      - name: edgeId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    delete:
      operationId: deleteLineageEdge
      summary: Delete a lineage edge
      responses:
        '204':
          description: Edge deleted
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /lineage/purge:
    post:
      operationId: purgeLineage
      summary: Purge old lineage edges
      description: Delete lineage edges older than the specified number of days.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurgeLineageRequest'
      responses:
        '200':
          description: Purge result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurgeLineageResponse'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # === Tags ===
  /tags:
    get:
      operationId: listTags
      summary: List all tags
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of tags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTags'
    post:
      operationId: createTag
      summary: Create a tag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagRequest'
      responses:
        '201':
          description: Created tag
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '409':
          description: Tag already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tags/{tagId}:
    parameters:
      - name: tagId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    delete:
      operationId: deleteTag
      summary: Delete a tag
      responses:
        '204':
          description: Tag deleted
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tags/{tagId}/assignments:
    parameters:
      - name: tagId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    post:
      operationId: assignTag
      summary: Assign a tag to a securable object
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagAssignmentRequest'
      responses:
        '201':
          description: Tag assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagAssignment'
        '409':
          description: Tag already assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tag-assignments/{assignmentId}:
    parameters:
      - name: assignmentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    delete:
      operationId: unassignTag
      summary: Remove a tag assignment
      responses:
        '204':
          description: Tag unassigned

  # === Classifications ===
  /classifications:
    get:
      operationId: listClassifications
      summary: List classification and sensitivity tags
      description: Returns all tags with governed classification/sensitivity prefixes.
      responses:
        '200':
          description: Classification tags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTags'

  # === Views ===
  /catalog/schemas/{schemaName}/views:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: listViews
      summary: List views in a schema
      parameters:
        - $ref: '#/components/parameters/MaxResults'
        - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Paginated list of views
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedViewDetails'
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      operationId: createView
      summary: Create a view in a schema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateViewRequest'
      responses:
        '201':
          description: View created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ViewDetail'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: View already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/views/{viewName}:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: viewName
        in: path
        required: true
        schema:
          type: string
    get:
      operationId: getView
      summary: Get a view by name
      responses:
        '200':
          description: View details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ViewDetail'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      operationId: updateView
      summary: Update a view's metadata
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateViewRequest'
      responses:
        '200':
          description: Updated view
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ViewDetail'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      operationId: dropView
      summary: Delete a view
      responses:
        '204':
          description: View deleted
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # === Ingestion ===
  /catalog/schemas/{schemaName}/tables/{tableName}/ingestion/upload-url:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    post:
      operationId: requestUploadUrl
      summary: Get a presigned URL for uploading a Parquet file
      description: >
        Returns a presigned PUT URL that the client can use to upload a Parquet file
        directly to S3. The file can then be registered via the commit endpoint.
        Requires INSERT privilege on the target table.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadUrlRequest'
      responses:
        '200':
          description: Presigned upload URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadUrlResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Table not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables/{tableName}/ingestion/commit:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    post:
      operationId: commitIngestion
      summary: Register uploaded Parquet files in DuckLake
      description: >
        Registers previously uploaded files (from upload-url) in the DuckLake catalog.
        DuckLake validates schema compatibility, extracts column statistics, and
        registers files atomically. Requires INSERT privilege on the target table.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommitIngestionRequest'
      responses:
        '200':
          description: Ingestion result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResult'
        '400':
          description: Validation error (schema mismatch, missing files, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Table not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/schemas/{schemaName}/tables/{tableName}/ingestion/load:
    parameters:
      - name: schemaName
        in: path
        required: true
        schema:
          type: string
      - name: tableName
        in: path
        required: true
        schema:
          type: string
    post:
      operationId: loadExternalFiles
      summary: Register existing S3 files in DuckLake
      description: >
        Registers existing S3 files or globs in the DuckLake catalog. Paths without
        an s3:// prefix are treated as relative to the lake data path. DuckLake validates
        schema compatibility, extracts column statistics, and registers files atomically.
        Requires INSERT privilege on the target table.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoadExternalRequest'
      responses:
        '200':
          description: Ingestion result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResult'
        '400':
          description: Validation error (schema mismatch, missing files, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Table not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
