# Plan: Hexagonal Architecture Restructure

## Goal
Restructure the project into hexagonal architecture (ports & adapters):
- **Domain** (`internal/domain/`) — core types, interfaces, errors. Imports nothing from the project.
- **Store** (`internal/db/`) — implements domain repository interfaces. Depends on domain.
- **Service** (`internal/service/`) — all business logic. Depends on domain interfaces.
- **Engine** (`internal/engine/`) — query execution. Depends on `domain.AuthorizationService` interface.
- **Entry point** (`cmd/server/`) — wiring and HTTP server.

Dependency rule: **Store → Domain ← Service**. Engine depends on a domain interface, not a concrete service.

```
cmd/server/main.go  (wiring)
       │
       ├── internal/api/         → internal/service/     → domain/ (interfaces)
       ├── internal/engine/      → domain.AuthorizationService (interface)
       ├── internal/service/     → domain/ (interfaces)
       └── internal/db/          → domain/ (implements interfaces)
```

---

## Target Structure

```
duck-demo/
├── cmd/
│   └── server/
│       └── main.go                  # Entry point (wiring, HTTP server)
├── internal/
│   ├── domain/                      # Core types + interfaces (imports NOTHING internal)
│   │   ├── principal.go
│   │   ├── grant.go                 # + privilege/securable constants
│   │   ├── row_filter.go
│   │   ├── column_mask.go           # + ColumnMaskWithBinding type
│   │   ├── audit.go
│   │   ├── introspection.go
│   │   ├── errors.go
│   │   └── repository.go           # Repository interfaces + AuthorizationService interface
│   ├── db/                          # Data access layer (Store)
│   │   ├── migrations/              # Goose SQL migrations (from catalog/migrations/)
│   │   │   └── 001-008_*.sql
│   │   ├── queries/                 # sqlc query definitions (from db/queries/)
│   │   │   └── *.sql
│   │   ├── dbstore/                 # sqlc generated Go code (from db/catalog/)
│   │   │   └── db.go, models.go, *.sql.go
│   │   ├── repository/              # Repository implementations (from internal/repository/)
│   │   │   ├── principal.go, group.go, grant.go, row_filter.go
│   │   │   ├── column_mask.go, audit.go, introspection.go
│   │   │   └── helpers.go
│   │   ├── mapper/                  # dbstore ↔ domain mappers (from internal/mapper/)
│   │   │   ├── domain_dbstore.go
│   │   │   └── domain_api.go
│   │   ├── migrate.go               # RunMigrations (from catalog/migrate.go)
│   │   └── embed.go                 # //go:embed migrations/*.sql
│   ├── engine/                      # SecureEngine (from engine/)
│   │   ├── engine.go                # Depends on domain.AuthorizationService interface
│   │   ├── engine_test.go
│   │   └── ducklake_test.go
│   ├── sqlrewrite/                  # SQL rewriting (from sqlrewrite/)
│   │   ├── sqlrewrite.go
│   │   └── sqlrewrite_test.go
│   ├── config/                      # Config loading (from config/)
│   │   ├── config.go
│   │   └── config_test.go
│   ├── api/                         # HTTP layer (from api/)
│   │   ├── openapi.yaml
│   │   ├── types.gen.go, server.gen.go
│   │   ├── handler.go
│   │   └── handler_test.go
│   ├── service/                     # ALL business logic services
│   │   ├── authorization.go         # AuthorizationService impl (from catalog/service.go)
│   │   ├── authorization_test.go    # (from catalog/service_test.go)
│   │   ├── query.go
│   │   ├── principal.go
│   │   ├── group.go
│   │   ├── grant.go
│   │   ├── row_filter.go
│   │   ├── column_mask.go
│   │   ├── introspection.go
│   │   └── audit.go
│   └── middleware/                   # Auth middleware
│       └── auth.go
├── sqlc.yaml                        # Updated paths
├── Makefile                         # Updated paths
└── go.mod
```

---

## Phases

### Phase 1: Move packages into `internal/` and entry point to `cmd/server/`

Pure file moves + import path updates. No logic changes yet.

| From | To | Notes |
|---|---|---|
| `main.go` | `cmd/server/main.go` | |
| `domain/` | `internal/domain/` | |
| `config/` | `internal/config/` | |
| `sqlrewrite/` | `internal/sqlrewrite/` | |
| `engine/` | `internal/engine/` | |
| `api/` | `internal/api/` | |
| `catalog/service.go` | `internal/service/authorization.go` | Change `package catalog` → `package service`, rename type `CatalogService` → `AuthorizationService` |
| `catalog/service_test.go` | `internal/service/authorization_test.go` | Same package rename |
| `catalog/migrations/*.sql` | `internal/db/migrations/` | |
| `catalog/migrate.go` | `internal/db/migrate.go` | Change `package catalog` → `package db`, new embed |
| `db/queries/` | `internal/db/queries/` | |
| `db/catalog/` | `internal/db/dbstore/` | |
| `internal/repository/` | `internal/db/repository/` | |
| `internal/mapper/` | `internal/db/mapper/` | |

**Every import path changes** from `duck-demo/X` to `duck-demo/internal/X`:
- `duck-demo/catalog` → `duck-demo/internal/service` (for AuthorizationService)
- `duck-demo/db/catalog` → `duck-demo/internal/db/dbstore`
- `duck-demo/domain` → `duck-demo/internal/domain`
- `duck-demo/engine` → `duck-demo/internal/engine`
- `duck-demo/config` → `duck-demo/internal/config`
- `duck-demo/sqlrewrite` → `duck-demo/internal/sqlrewrite`
- `duck-demo/api` → `duck-demo/internal/api`
- `duck-demo/internal/repository` → `duck-demo/internal/db/repository`
- `duck-demo/internal/mapper` → `duck-demo/internal/db/mapper`

**Rename in catalog→service transition:**
- `catalog.CatalogService` → `service.AuthorizationService`
- `catalog.NewCatalogService()` → `service.NewAuthorizationService()`
- `catalog.RunMigrations()` → `db.RunMigrations()` (now in internal/db)
- `catalog.PrivSelect` etc. stay temporarily until Phase 2 moves them to domain

Create `internal/db/embed.go`:
```go
package db

import "embed"

//go:embed migrations/*.sql
var EmbedMigrations embed.FS
```

Update `internal/db/migrate.go` to use `EmbedMigrations` from same package.

Update `sqlc.yaml`:
```yaml
schema: "internal/db/migrations"
queries: "internal/db/queries"
out: "internal/db/dbstore"
```

Update `Makefile`: `MIGRATIONS_DIR = internal/db/migrations`

Regenerate sqlc. Update oapi-codegen paths in Makefile.

**Verify:** `go build ./...` and `go test -race ./...`

### Phase 2: Add missing domain interfaces + move constants

**`internal/domain/repository.go`** — add `AuthorizationService` interface:
```go
type AuthorizationService interface {
    LookupTableID(ctx context.Context, tableName string) (tableID, schemaID int64, err error)
    CheckPrivilege(ctx context.Context, principalName, securableType string, securableID int64, privilege string) (bool, error)
    GetEffectiveRowFilters(ctx context.Context, principalName string, tableID int64) ([]string, error)
    GetEffectiveColumnMasks(ctx context.Context, principalName string, tableID int64) (map[string]string, error)
}
```

**`GrantRepository`** — add:
```go
HasPrivilege(ctx context.Context, principalID int64, principalType, securableType string, securableID int64, privilege string) (bool, error)
```

**`RowFilterRepository`** — add:
```go
GetForTableAndPrincipal(ctx context.Context, tableID, principalID int64, principalType string) ([]RowFilter, error)
```

**`ColumnMaskRepository`** — add:
```go
GetForTableAndPrincipal(ctx context.Context, tableID, principalID int64, principalType string) ([]ColumnMaskWithBinding, error)
```

**`IntrospectionRepository`** — add:
```go
GetTableByName(ctx context.Context, tableName string) (*Table, error)
GetSchemaByName(ctx context.Context, schemaName string) (*Schema, error)
```

**`internal/domain/column_mask.go`** — add:
```go
type ColumnMaskWithBinding struct {
    ColumnName     string
    MaskExpression string
    SeeOriginal    bool
}
```

**`internal/domain/grant.go`** — move constants from service:
```go
const (
    PrivSelect        = "SELECT"
    PrivInsert        = "INSERT"
    PrivUpdate        = "UPDATE"
    PrivDelete        = "DELETE"
    PrivUsage         = "USAGE"
    PrivAllPrivileges = "ALL_PRIVILEGES"

    SecurableCatalog = "catalog"
    SecurableSchema  = "schema"
    SecurableTable   = "table"

    CatalogID int64 = 0
)
```

Remove these constants from `internal/service/authorization.go`. Update all references (`engine`, `service`, etc.) to use `domain.PrivSelect`, `domain.SecurableTable`, etc.

**Verify:** `go build ./...`

### Phase 3: Implement missing repository methods

**`internal/db/repository/grant.go`** — add `HasPrivilege` (wraps existing `CheckDirectGrantAny` sqlc query).

**`internal/db/repository/row_filter.go`** — add `GetForTableAndPrincipal` (wraps existing `GetRowFiltersForTableAndPrincipal` sqlc query).

**`internal/db/repository/column_mask.go`** — add `GetForTableAndPrincipal` (wraps existing `GetColumnMaskForTableAndPrincipal` sqlc query).

**`internal/db/repository/introspection.go`** — add `GetTableByName` and `GetSchemaByName` (raw SQL, same logic as current `LookupTableID`/`LookupSchemaID`).

**Verify:** `go build ./...`

### Phase 4: Refactor authorization service to use domain interfaces

Rewrite `internal/service/authorization.go`:
- Replace `*dbstore.Queries` + `*sql.DB` with domain repository interfaces:
  ```go
  type AuthorizationService struct {
      principals    domain.PrincipalRepository
      groups        domain.GroupRepository
      grants        domain.GrantRepository
      rowFilters    domain.RowFilterRepository
      columnMasks   domain.ColumnMaskRepository
      introspection domain.IntrospectionRepository
  }
  ```
- `CheckPrivilege` → `s.principals.GetByName()`, `s.groups.GetGroupsForMember()`, `s.grants.HasPrivilege()`
- `GetEffectiveRowFilters` → `s.rowFilters.GetForTableAndPrincipal()`
- `GetEffectiveColumnMasks` → `s.columnMasks.GetForTableAndPrincipal()`
- `LookupTableID` → `s.introspection.GetTableByName()`
- Remove `Queries()` and `DB()` accessors
- Remove `dbstore` import — service now only imports `domain`

Update `internal/service/authorization_test.go` to construct with repositories.

**Verify:** `go build ./...` and `go test -race ./internal/service/...`

### Phase 5: Refactor engine to use domain interface

Update `internal/engine/engine.go`:
- Replace concrete `*service.AuthorizationService` with `domain.AuthorizationService` interface
- Use `domain.SecurableTable`, `domain.PrivSelect`, etc.
- Remove service package import

Update tests — construct real `AuthorizationService` (with repos) and pass as `domain.AuthorizationService`.

**Verify:** `go build ./...` and `go test -race ./internal/engine/...`

### Phase 6: Fix remaining dbstore leaks

**`internal/middleware/auth.go`** — refactor to use domain interface/repository instead of raw dbstore.

**`cmd/server/main.go`** — refactor `seedCatalog()` to use repositories instead of `cat.Queries()`.

**`internal/service/query.go`** — depends on `*engine.SecureEngine` directly. Leave as-is (both in `internal/`), or define a `domain.QueryExecutor` interface if desired.

**Verify:** `go build ./...` and `go test -race ./...`

### Phase 7: Final cleanup

- Delete empty old directories (`catalog/`, `db/queries/`, `db/catalog/`, top-level `domain/`, `config/`, `engine/`, `sqlrewrite/`, `api/`)
- Regenerate API code with updated Makefile paths
- Full verification

---

## Key Dependency Graph (After Refactor)

```
cmd/server/main.go
  ├── internal/api           → internal/service, internal/domain, internal/middleware
  ├── internal/service       → internal/domain (interfaces only)
  │   ├── authorization.go   → domain.PrincipalRepository, GroupRepository, GrantRepository, etc.
  │   └── query.go           → internal/engine (concrete, both in internal/)
  ├── internal/engine        → internal/domain (AuthorizationService interface), internal/sqlrewrite
  ├── internal/db/repository → internal/domain (implements interfaces), internal/db/dbstore
  ├── internal/db/mapper     → internal/domain, internal/db/dbstore
  ├── internal/middleware     → internal/domain
  └── internal/config        → (stdlib only)

internal/domain → (stdlib only, zero internal imports)
```

No package outside `internal/` imports project packages. No circular dependencies.

---

## Verification (each phase)
```bash
go build ./...
go vet ./...
go test -race ./...
```
