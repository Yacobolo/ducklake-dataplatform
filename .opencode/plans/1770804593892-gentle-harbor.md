# Plan: SQLite Connection Hardening with Read/Write Pool Split

## Problem

The SQLite metastore (`ducklake_meta.sqlite`) is opened with a bare DSN (`?_foreign_keys=on`) and no connection pool configuration. This file is accessed concurrently by:
1. **Go's go-sqlite3 driver** — for RBAC, audit, query history, and DuckLake metadata reads
2. **DuckDB's ducklake extension** — for catalog DDL and metadata writes

Without WAL mode, busy_timeout, or pool limits, this setup is vulnerable to `SQLITE_BUSY` errors under concurrent load.

## Solution

1. Add a helper that opens SQLite with hardened DSN parameters
2. Split into two pools: a **write pool** (MaxOpenConns=1, `_txlock=immediate`) and a **read pool** (MaxOpenConns=4)
3. Wire repositories to the appropriate pool based on read/write behavior
4. Add a test helper and update existing tests

## Changes

### 1. New file: `internal/db/sqlite.go`

Two exported functions:

```go
func OpenSQLite(path string, mode string, maxOpen int) (*sql.DB, error)
func OpenSQLitePair(path string, readMaxOpen int) (writeDB, readDB *sql.DB, err error)
```

**DSN parameters (both pools):**
- `_journal_mode=WAL` — concurrent read/write
- `_busy_timeout=5000` — wait up to 5s for locks (hardcoded)
- `_synchronous=NORMAL` — safe with WAL, better perf
- `_foreign_keys=on` — preserve existing behavior

**Write pool only:**
- `_txlock=immediate` — acquire write-lock at BEGIN, avoid lock upgrade deadlocks
- `MaxOpenConns=1`, `MaxIdleConns=1`

**Read pool only:**
- No `_txlock` (uses default DEFERRED for shared locks)
- `MaxOpenConns=4`, `MaxIdleConns=4`

Both pools: `ConnMaxLifetime=time.Hour`

### 2. New file: `internal/db/sqlite_test.go`

Unit tests for `OpenSQLite` and `OpenSQLitePair`:
- Verify WAL mode is active (`PRAGMA journal_mode`)
- Verify busy_timeout is set (`PRAGMA busy_timeout`)
- Verify pool sizes
- Verify concurrent reads work on the read pool
- Verify write serialization on the write pool

### 3. New test helper in `internal/db/testhelper.go`

```go
func OpenTestSQLite(t *testing.T) (writeDB, readDB *sql.DB)
```

Opens a pair in `t.TempDir()`, runs migrations, registers `t.Cleanup`. Tests that don't need the split can use `writeDB` for everything.

### 4. Modify `cmd/server/main.go`

**Replace** (line 247):
```go
metaDB, err := sql.Open("sqlite3", metaDBPath+"?_foreign_keys=on")
```

**With:**
```go
writeDB, readDB, err := internaldb.OpenSQLitePair(metaDBPath, 4)
```

**Repository wiring** — pass the appropriate pool:

| Pool | Repositories |
|------|-------------|
| **writeDB** | PrincipalRepo, GroupRepo, GrantRepo, RowFilterRepo, ColumnMaskRepo, AuditRepo, LineageRepo, TagRepo, ViewRepo, CatalogRepo (+ duckDB) |
| **readDB** | IntrospectionRepo, QueryHistoryRepo, SearchRepo, APIKeyRepo |

**Other consumers:**
- `RunMigrations(writeDB)` — DDL needs write access
- `seedCatalog` — uses `dbstore.New(writeDB)` for INSERTs
- `ManifestService` — receives `readDB` (SELECT-only on ducklake_* tables)
- `IngestionService` — receives `readDB` (SELECT-only on ducklake_metadata via `readDataPath`)

### 5. Update test files (5 files, ~9 call sites)

Replace direct `sql.Open("sqlite3", ...)` calls with `internaldb.OpenTestSQLite(t)`:

| File | Lines | Notes |
|------|-------|-------|
| `internal/api/handler_test.go` | 50, 334 | Use `writeDB` for all repos (tests are single-goroutine) |
| `internal/engine/engine_test.go` | 27 | Same |
| `internal/engine/ducklake_test.go` | 96 | Same |
| `internal/service/authorization_test.go` | 22 | Same |
| `test/integration/helpers_test.go` | 113, 532, 778, 874 | Lower priority, can adopt incrementally |

## Files Modified (Summary)

| File | Action |
|------|--------|
| `internal/db/sqlite.go` | **CREATE** — OpenSQLite, OpenSQLitePair, buildDSN |
| `internal/db/sqlite_test.go` | **CREATE** — unit tests for above |
| `internal/db/testhelper.go` | **CREATE** — OpenTestSQLite helper |
| `cmd/server/main.go` | **EDIT** — replace single pool with pair, rewire repos |
| `internal/api/handler_test.go` | **EDIT** — use OpenTestSQLite |
| `internal/engine/engine_test.go` | **EDIT** — use OpenTestSQLite |
| `internal/engine/ducklake_test.go` | **EDIT** — use OpenTestSQLite |
| `internal/service/authorization_test.go` | **EDIT** — use OpenTestSQLite |
| `test/integration/helpers_test.go` | **EDIT** — use OpenTestSQLite |

**No changes to:** repository structs, constructor signatures, domain interfaces, service layer, or sqlc-generated code.

## Verification

1. `task build` — compiles cleanly
2. `task test` — all unit tests pass
3. `task vet` — no issues
4. Manual check: `PRAGMA journal_mode` returns `wal` at startup (add a log line or verify in tests)
5. Verify `SQLITE_BUSY` resilience: concurrent read/write test in `sqlite_test.go`
