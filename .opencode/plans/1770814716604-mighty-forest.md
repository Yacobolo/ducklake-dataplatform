# Code Smell Remediation Plan

## Overview
Comprehensive code smell review of `duck-demo` — a Go data platform providing a secure SQL query layer over DuckDB with RBAC, row-level security, and column masking. Found **48 distinct code smells** across all layers, grouped into 4 priority tiers.

---

## Tier 1 — Critical / Security (fix immediately)

### Group 1A: SQL Rewrite Security Holes
**Effort: L | Files: `internal/sqlrewrite/sqlrewrite.go`, `internal/engine/engine.go`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 1 | **`SELECT *` bypasses column masks** — `ApplyColumnMasks` only processes explicit `ColumnRef` nodes; `A_Star` is ignored, so `SELECT * FROM table` is never masked | `sqlrewrite.go:322-347` | Detect `A_Star` in target list → expand to explicit column list using table metadata, then apply masks. Add test for `SELECT *` with masks. |
| 2 | **Multi-statement SQL bypasses classification** — `ClassifyStatement` only checks `Stmts[0]`; `SELECT 1; DROP TABLE foo` classified as SELECT | `sqlrewrite.go:120` | Reject input with `len(Stmts) > 1` by returning an error. Add test case. |
| 3 | **Row filter/mask expressions injected without validation** — expressions from metastore parsed and injected verbatim; subqueries could leak data | `sqlrewrite.go:177-178, 338-341` | Add allowlist validation: reject expressions containing subqueries (`SubLink`), function calls to blocklisted functions, or `UNION/EXCEPT/INTERSECT`. |
| 4 | **Failed mask parse silently leaves column unmasked** — `continue` on parse error = security degradation | `sqlrewrite.go:341` | Return an error instead of continuing. Caller should fail the query rather than serve unmasked data. |
| 5 | **`information_schema` rewrite is case-incomplete** — only handles exact lowercase and uppercase; mixed case bypasses virtual info schema | `engine/information_schema.go:167-169` | Use `strings.EqualFold` or regex for case-insensitive replacement, or better: use AST-based rewriting consistent with the rest of the codebase. |

### Group 1B: Error Handling Semantics
**Effort: M | Files: `internal/api/handler.go`, `internal/engine/engine.go`, `internal/db/repository/helpers.go`, `internal/db/mapper/domain_api.go`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 6 | **`switch err.(type)` used ~20 times instead of `errors.As`**; wrapped errors not caught. Existing `HTTPStatusFromDomainError` mapper in `domain_api.go` is unused | `handler.go` (throughout), `domain_api.go:11-29` | Replace all inline error switches with the centralized `HTTPStatusFromDomainError` mapper, updated to use `errors.As`. |
| 7 | **Engine access denied returns `fmt.Errorf` not domain error** → 500 instead of 403 | `engine.go:92` | Return `domain.ErrAccessDenied(...)` |
| 8 | **`ExecuteQuery` returns 403 for all errors** (parse, internal, etc.) | `handler.go:96-98` | Use the centralized error mapper to return appropriate status codes. |
| 9 | **`DeleteSchema` maps `ConflictError` to 403** instead of 409 | `handler.go:651-652` | Fix the mapping to return 409. |
| 10 | **`mapDBError` uses `==` instead of `errors.Is`** (11 occurrences) | `repository/helpers.go:21`, `catalog.go`, `table_statistics.go`, `introspection.go` | Replace `err == sql.ErrNoRows` with `errors.Is(err, sql.ErrNoRows)` everywhere. |
| 11 | **`APIKeyRepo` leaks raw `sql.ErrNoRows`** | `repository/api_key.go:19-25` | Map through `mapDBError` like other repos. |

### Group 1C: Data Integrity
**Effort: M | Files: `internal/db/repository/catalog.go`, `internal/db/mapper/domain_dbstore.go`, `internal/config/config.go`, `internal/service/grant.go`, `internal/service/row_filter.go`, `internal/service/column_mask.go`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 12 | **Missing transactions on cascade deletes** — DeleteSchema (10 cleanup queries) and DeleteTable (7 queries) without tx | `catalog.go:217-301, 451-508` | Wrap SQLite cleanup steps in `db.BeginTx` / `q.WithTx()`. |
| 13 | **Manual JSON construction bug** — string concat to build JSON; invalid if table names contain quotes | `mapper/domain_dbstore.go:268-270` | Replace with `json.Marshal(e.TablesAccessed)`. |
| 14 | **Silenced governance cascade errors** — 19 `_ = r.q.DeleteXxx(...)` on row filters, column masks, tag assignments | `catalog.go:260-298, 476-505` | At minimum log errors. Ideally: collect errors and return a multi-error so callers know about partial failures. |
| 15 | **"system" hardcoded as audit principal** in 3 services | `grant.go:27`, `row_filter.go:28`, `column_mask.go:29` | Accept principal as parameter (from context or explicit arg) like other services. |
| 16 | **Insecure hardcoded defaults** — JWT secret and encryption key with no runtime warning | `config/config.go:64-68` | Log a loud warning at startup when defaults are used; refuse to start in non-dev mode. |

### Group 1D: C++ Extension Cache Security
**Effort: L | File: `extension/duck_access/src/duck_access_manifest.cpp`, `duck_access_manifest.hpp`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 17 | **Global manifest cache not per-user** — cache keyed by `schema.table` only; different users' RLS policies served cross-tenant | `duck_access_manifest.hpp:55-56` | Key the cache by `(api_key_hash, schema, table)` or by user identity. |

---

## Tier 2 — High (fix within 2 weeks)

### Group 2A: Architecture — Service Layer Coupling
**Effort: M | Files: 6 service files, `internal/middleware/`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 18 | **Service layer imports `middleware` to extract principal** — violates `api → service → domain` direction | `catalog.go`, `tags.go`, `views.go`, `external_location.go`, `storage_credential.go`, `ingestion.go` | Pass principal as explicit `string` parameter to service methods (as `QueryService.Execute` already does). |
| 19 | **Services directly execute raw SQL** bypassing repository layer | `manifest.go:175-217`, `ingestion.go:261-269` | Move DuckLake metadata queries into the repository layer. |
| 20 | **`ExternalLocationService` mixes 4 concerns** — CRUD, secrets, catalog attachment, authz | `external_location.go` | Extract secret lifecycle and catalog attachment into dedicated collaborators. |

### Group 2B: Handler Refactoring
**Effort: L | Files: `internal/api/handler.go`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 21 | **`APIHandler` god object — 18 deps, 1810 lines** | `handler.go:13-32` | Split into sub-handlers by domain (SecurityHandler, CatalogHandler, IngestionHandler). Use an options struct for `NewHandler`. Extract ~25 mapping functions to `api_mappers.go`. |

### Group 2C: Deduplication
**Effort: S-M | Multiple files**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 22 | **6 identical `logAudit` methods** | 6 service files | Extract to shared `auditHelper.LogAction(ctx, repo, principal, action, detail)`. |
| 23 | **2 identical `requireCatalogAdmin` methods** | `storage_credential.go`, `external_location.go` | Extract to shared auth helper. |
| 24 | **2 identical `resolvePresigner` implementations** | `manifest.go`, `ingestion.go` | Extract to a shared `PresignerResolver` collaborator. |
| 25 | **8 repeated privilege-check patterns** | `catalog.go` | Extract `requirePrivilege(ctx, securable, privilege)` helper. |
| 26 | **Dead code: unused `RLSRule`/`RewriteQuery` + unused `HTTPStatusFromDomainError`** | `sqlrewrite.go:27-78`, `domain_api.go:11-29` | Remove `RLSRule`/`RewriteQuery` (after adopting mapper in 1B). |

### Group 2D: N+1 Query Performance
**Effort: M | File: `internal/db/repository/catalog.go`**

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 27 | **N+1 queries for metadata enrichment** — ListSchemas, ListTables, GetTable, ListColumns all do per-item metadata fetch | `catalog.go:182-184, 391-393, 444-446, 563-565` | Add batch `GetCatalogMetadataBatch(ctx, securableNames)` query. |
| 28 | **N+1 in DeleteSchema cascade** — 3 queries per table | `catalog.go:277-285` | Use `WHERE table_id IN (...)` batch queries. |

---

## Tier 3 — Medium (fix within 1 month)

| # | Issue | Location | Effort | Fix |
|---|-------|----------|--------|-----|
| 29 | **Magic numbers/strings** — `1000`, `10000` page sizes; `"lake"` catalog; `"duck-demo"` bucket; 1-hour expiry; 128 name limit | Multiple files (8+ locations each) | S | Define named constants in `domain` or `config` package. |
| 30 | **Duplicated utility functions** — `ptrToStr`/`stringFromPtr`/`ptrStr` (3 copies), `boolToInt` (2), `nullInt64`/`nullInt` (2) | `repository/catalog.go`, `repository/views.go`, `mapper/domain_dbstore.go` | S | Consolidate into `internal/db/mapper/` or a new `internal/db/dbutil/` package. |
| 31 | **Time format string duplicated 14 times** instead of using the constant in mapper | All repository files | S | Use shared `const timeLayout`. |
| 32 | **Silently discarded `time.Parse`/`json.Unmarshal` errors** (14+ occurrences) | Repository and mapper layers | S | At minimum log; ideally propagate. |
| 33 | **Missing `rows.Err()` checks** after `rows.Next()` loops | `catalog.go`, `search.go` | S | Add `rows.Err()` check after every loop. |
| 34 | **Read-modify-write without transactions** — ViewRepo.Update, StorageCredentialRepo.Update, ExternalLocationRepo.Update | 3 repository files | S | Wrap in transactions. |
| 35 | **`SearchRepo.Search` — 171 lines, dynamic UNION ALL, `fmt.Sprintf` for LIMIT/OFFSET** | `repository/search.go:20-191` | M | Parameterize LIMIT/OFFSET; extract query-building into testable functions. |
| 36 | **Deep nesting** — resolvePresigner (6 levels), JWT extraction (4 levels) | `ingestion.go`, `manifest.go`, `auth.go` | S | Use early returns / guard clauses. Will be partially fixed by dedup (#24). |
| 37 | **`seedCatalog` (174 lines) + `main` (235 lines)** | `cmd/server/main.go` | S | Extract `seedPrincipals`, `seedGroups`, `seedGrants`, `setupRouter`, etc. |
| 38 | **Duplicated pagination Count-then-List pattern** — 12 repositories | All repository files | M | Create generic `Paginate[T]` helper or code-generate the boilerplate. |
| 39 | **Test quality** — engine tests don't use testify, aren't table-driven, have duplicate setup, discard errors | `engine_test.go`, `ducklake_test.go`, `sqlrewrite_test.go` | M | Refactor to table-driven with testify; extract shared `setupEngine` helper; add missing edge case tests (SELECT *, multi-statement). |

---

## Tier 4 — Low (opportunistic)

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| 40 | Missing doc comments on 5 service types | `internal/service/*.go` | Add GoDoc comments. |
| 41 | Inconsistent naming (`Get` vs `GetByName` vs `GetByID`) | `internal/domain/repository.go` | Standardize repository method naming. |
| 42 | Redundant `dbstore.Queries` allocations | Repository constructors | Share single `*dbstore.Queries` from composition root. |
| 43 | Re-exported domain constants in `authorization.go` | `internal/service/authorization.go:11-26` | Remove; point callers at `domain.*` directly. |
| 44 | Temp table accumulation in long-lived DuckDB connections | `engine/information_schema.go` | Add cleanup after query execution. |
| 45 | C++ extension: no TLS cert verification, minimal tests, static init risk | `extension/duck_access/src/` | Enable TLS verification; add unit tests for manifest parsing, cache, error handling. |
| 46 | Lossy null round-trip (empty string ↔ NULL) | `repository/group.go`, `row_filter.go`, `column_mask.go`, `mapper/domain_dbstore.go` | Use `*string` in domain for optional fields; map `NULL` ↔ `nil`. |
| 47 | `LookupTableID` doesn't accept schema context | `domain/repository.go:179` | Accept `(schema, table)` pair to avoid ambiguity. |
| 48 | `GetManifest` default case returns 403 for unknown errors | `handler.go:122-129` | Default should be 500. Will be fixed by centralized error mapper (#6). |

---

## Suggested Execution Order

```
Week 1:  Group 1A (SQL security) + Group 1B (error handling)
Week 2:  Group 1C (data integrity) + Group 1D (C++ cache)
Week 3:  Group 2A (architecture) + Group 2C (dedup)
Week 4:  Group 2B (handler refactor) + Group 2D (N+1 queries)
Week 5+: Tier 3 and 4 (ongoing)
```

### Key Dependencies
- Fix #6 (centralized error mapper) before #8, #9, #48
- Fix #18 (remove middleware import) before #21 (handler refactor)
- Fix #22-25 (dedup) before or during #21 (handler refactor)
- Fix #1 (SELECT * masks) requires access to table column metadata in sqlrewrite layer

## Verification
- `task test` — all unit tests pass after each group
- `task vet` — no vet warnings
- `task build` — clean build
- Manual security testing: `SELECT * FROM table_with_masks` must show masked values
- Manual testing: multi-statement SQL must be rejected
- `task integration-test` after Tier 1 complete (if S3 creds available)
