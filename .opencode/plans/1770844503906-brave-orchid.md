# Plan: Fix All 580 golangci-lint Issues

## Summary

Fix all 580 lint warnings across 8 phases. Use `rg` for dry-run pattern discovery and `sed` for bulk replacements wherever possible. Each phase is independently verifiable via `task lint`.

---

## Phase 1: Config Suppressions & Trivial Fixes (~87 issues)

**Goal:** Reduce noise via `.golangci.yml` exclusions and targeted `//nolint` comments.

### 1a. Update `.golangci.yml` exclusions

Add to `exclusions.rules`:
```yaml
- path: internal/api/handler\.go
  linters:
    - revive
  text: "exported:"
- path: cmd/server/main\.go
  linters:
    - revive
  text: "unused-parameter"
```

**Files:** `.golangci.yml`

### 1b. Suppress false-positive gosec warnings (2 nolint comments)

- `internal/config/config.go:80` — add `//nolint:gosec // path is caller-controlled`
- `internal/engine/information_schema.go:166` — add `//nolint:gosec // tempName and placeholders are internally generated`

**Files:** `internal/config/config.go`, `internal/engine/information_schema.go`

**Verify:** `task lint 2>&1 | tail -15` — expect ~87 fewer issues

---

## Phase 2: Dead Code Removal & Mechanical Fixes (~11 issues)

### 2a. Delete unused functions (3 unused issues)

- Delete `formatTime` and `boolToInt` from `internal/db/mapper/domain_dbstore.go:19-27`
- Delete `isDomainError` from `internal/api/handler.go:107-111`

### 2b. Fix gocritic issues (5 issues)

1. **exitAfterDefer** (`cmd/server/main.go`): Extract `run() error` from `main()`. All `log.Fatalf` become `return fmt.Errorf(...)`. `main()` becomes:
   ```go
   func main() {
       if err := run(); err != nil {
           fmt.Fprintf(os.Stderr, "fatal: %v\n", err)
           os.Exit(1)
       }
   }
   ```

2. **ifElseChain** (`internal/api/handler.go:312`): Convert `if/else if/else` in `ListGrants` to `switch { case ...: }`.

3. **deprecatedComment** (`internal/ddl/builder.go:150`, `internal/engine/engine.go:235`): Put `Deprecated:` in its own paragraph:
   ```go
   // DropS3Secret returns a DuckDB DDL statement.
   //
   // Deprecated: Use DropSecret instead.
   ```

4. **singleCaseSwitch** (`internal/sqlrewrite/sqlrewrite.go:628`): Convert single-case `switch` to `if`.

### 2c. Fix gosec G114 (`cmd/server/main.go:484`)

Replace `http.ListenAndServe` with configured `http.Server{}` with timeouts. (Done as part of the `run()` extraction.)

### 2d. Fix staticcheck (2 issues)

Verify and fix during implementation (likely SA1019 deprecated usage).

**Files:** `cmd/server/main.go`, `internal/api/handler.go`, `internal/db/mapper/domain_dbstore.go`, `internal/ddl/builder.go`, `internal/engine/engine.go`, `internal/sqlrewrite/sqlrewrite.go`

---

## Phase 3: errorlint — Bulk Fix Error Comparisons (~39 issues)

### 3a. `err == sql.ErrNoRows` → `errors.Is` (10 instances — sed)

**Dry run:**
```bash
rg 'err == sql\.ErrNoRows' --type go
```

**Bulk replace:**
```bash
sed -i '' 's/err == sql\.ErrNoRows/errors.Is(err, sql.ErrNoRows)/g' \
  internal/db/repository/catalog.go \
  internal/db/repository/introspection.go \
  internal/db/repository/table_statistics.go
```

Then add `"errors"` import to `catalog.go` and `introspection.go` (already present in `table_statistics.go` — verify).

### 3b. `switch err.(type)` → `errors.As` in handler.go (33 instances)

These cannot be a single sed due to varying case arms and response types. There are **6 shapes** with different case combinations. Strategy:

**Shape A — single-case `NotFoundError` (11 instances, sed-friendly):**
```bash
# Dry run — find all single-case NotFoundError switches:
rg -A4 'switch err\.\(type\)' internal/api/handler.go | grep -B1 'NotFoundError'
```
Each block:
```go
switch err.(type) {
case *domain.NotFoundError:
    return XxxNNN404JSONResponse{...}, nil
default:
    return nil, err
}
```
→ becomes:
```go
var notFound *domain.NotFoundError
switch {
case errors.As(err, &notFound):
    return XxxNNN404JSONResponse{...}, nil
default:
    return nil, err
}
```
These need per-handler edits since response types differ. Use `rg -n 'switch err\.\(type\)' internal/api/handler.go` to get all 33 line numbers, then edit sequentially.

**Shape D — two-case `AccessDenied + NotFound` (13 instances):**
Same approach — add `var` declarations and convert `case *domain.X:` to `case errors.As(err, &x):`.

**Shapes E/F — multi-case (remaining ~9 instances):**
Manual edits following the existing pattern from `CreateStorageCredential` (line 1579).

**Shape G — `switch code` (4 instances):**
These already use `errorCodeFromError(err)` which internally uses `errors.As`. They are NOT flagged by errorlint — leave unchanged.

**File:** `internal/api/handler.go`

---

## Phase 4: nilerr — Fix 5 Handler Error Patterns (~5 issues)

5 handlers return a single typed HTTP response for all errors:
1. `CreatePrincipal` (line 197) — always 400
2. `GetPrincipal` (line 205) — always 404
3. `DeletePrincipal` (line 212) — always 404
4. `UpdatePrincipalAdmin` (line 219) — always 404
5. `GetGroup` (line 255) — always 404

**Fix:** Replace simple `if err != nil { return X, nil }` with proper `switch { case errors.As(...) }` blocks. Each gets a `default: return nil, err` fallback.

**File:** `internal/api/handler.go`

---

## Phase 5: revive — Rename, Package Comments, Export Docs (~115 issues)

### 5a. Rename `APIHandler` → `Handler` (sed — all in one file)

**Dry run:**
```bash
rg 'APIHandler' internal/api/handler.go --count  # ~85 matches, all in this one file
```

**Bulk replace:**
```bash
sed -i '' 's/APIHandler/Handler/g' internal/api/handler.go
```

Update the doc comment on line 14:
```go
// Handler implements the StrictServerInterface.
```

No other files reference `APIHandler` (verified).

### 5b. Add package doc comments (~90 issues — 12 files to edit)

Add `// Package X ...` as first line of one file per package. Create `doc.go` files or prepend to existing files:

| Package | File to edit | Comment to add |
|---------|-------------|----------------|
| `cmd/server` | `main.go` | `// Package main is the entry point for the data platform server.` |
| `internal/api` | `handler.go` | `// Package api implements the HTTP handler layer for the data platform API.` |
| `internal/service` | `audit.go` | `// Package service implements business logic for the data platform.` |
| `internal/engine` | `engine.go` | `// Package engine provides the DuckDB execution engine with RBAC, RLS, and column masking.` |
| `internal/domain` | `errors.go` | `// Package domain defines core types, interfaces, and errors for the data platform.` |
| `internal/db` | `sqlite.go` | `// Package db provides database connectivity helpers and migration support.` |
| `internal/db/repository` | `helpers.go` | `// Package repository implements domain repository interfaces using SQLite.` |
| `internal/db/mapper` | `domain_api.go` | `// Package mapper converts between domain, database, and API layer types.` |
| `internal/db/crypto` | `encrypt.go` | `// Package crypto provides encryption utilities for sensitive data at rest.` |
| `internal/middleware` | `auth.go` | `// Package middleware provides HTTP middleware for JWT and API key authentication.` |
| `internal/config` | `config.go` | `// Package config handles application configuration and environment loading.` |
| `internal/ddl` | `builder.go` | `// Package ddl builds DuckDB DDL statements for secrets, extensions, and catalog operations.` |
| `test/integration` | `helpers_test.go` | `// Package integration contains end-to-end HTTP integration tests.` |

**Bulk approach:** For each file, `sed -i '' '1s/^package/\/\/ Package X ...\npackage/' <file>`.

### 5c. Add doc comments to exported non-handler functions (~24 issues)

Mainly in `internal/db/mapper/domain_dbstore.go` (~24 exported functions) and scattered across other packages. These need manual per-function comments.

**Dry run — find all undocumented exports:**
```bash
rg '^func [A-Z]' internal/db/mapper/domain_dbstore.go  # ~24 matches
rg -B1 '^func [A-Z]|^type [A-Z]' internal/service/*.go internal/engine/*.go | grep -v '//'
```

---

## Phase 6: Production Code errcheck & rowserrcheck (~32 issues)

### 6a. `defer rows.Close()` → `defer rows.Close() //nolint:errcheck` (20 instances — sed)

**Dry run:**
```bash
rg -n 'defer rows\.Close\(\)' --type go --glob '!*_test.go' --glob '!*/dbstore/*'
```
20 instances in non-test, non-generated code.

**Bulk replace:**
```bash
sed -i '' 's/defer rows\.Close()/defer rows.Close() \/\/nolint:errcheck \/\/ rows.Close errors are not actionable/g' \
  internal/db/repository/catalog.go \
  internal/db/repository/introspection.go \
  internal/db/repository/search.go \
  internal/engine/engine.go \
  internal/service/manifest.go \
  internal/service/query.go
```

### 6b. `conn.Close()` in `information_schema.go` (3 instances)

These are in error paths (not deferred). Fix: `_ = conn.Close()` or check properly.

**File:** `internal/engine/information_schema.go`

### 6c. Fix `json.Unmarshal` unchecked (4 instances)

In `internal/db/mapper/domain_dbstore.go:248,293,365,372` — wrap with error checking:
```go
if err := json.Unmarshal(...); err != nil {
    // log or handle
}
```

### 6d. Fix remaining production errcheck (~5 instances)

- `internal/db/sqlite.go:55,75` — `_ = db.Close()` on error paths
- `internal/config/config.go:87` — `defer f.Close()` → `defer f.Close() //nolint:errcheck`
- `internal/config/config.go:103` — check `os.Setenv()` error
- `internal/middleware/auth.go:71` — check `json.Encode()` error
- `cmd/server/main.go:459` — `_ = fmt.Fprint(w, ...)`

### 6e. Fix rowserrcheck in production code (2 instances)

- `internal/db/repository/catalog.go` (~line 248): Add `if err := rows.Err(); err != nil { ... }` after loop
- `internal/db/repository/search.go` (~line 181): Same

---

## Phase 7: Test Code Fixes (~270 issues)

Largest phase. Use `rg`/`sed` for the repetitive patterns.

### 7a. testifylint — `assert.True(t, errors.As(...))` → `require.ErrorAs` (21 instances — sed)

**Dry run:**
```bash
rg -n 'assert\.True\(t, errors\.As\(' --type go --glob '*_test.go'
```
21 instances across 6 files in `internal/service/`.

**Bulk replace:**
```bash
sed -i '' 's/assert\.True(t, errors\.As(\(.*\), \(.*\)))/require.ErrorAs(t, \1, \2)/g' \
  internal/service/views_test.go \
  internal/service/storage_credential_test.go \
  internal/service/tags_test.go \
  internal/service/lineage_test.go \
  internal/service/external_location_test.go
```

May need to add `"github.com/stretchr/testify/require"` import where missing.

### 7b. testifylint — remaining `assert.True` patterns (~21 instances — manual)

- `assert.True(t, strings.Contains(...))` → `assert.Contains(t, ...)` (1 in engine_test.go)
- `assert.True(t, strings.HasPrefix(...))` → `assert.True(t, strings.HasPrefix(...))` with `//nolint:testifylint` or use custom check
- `assert.True(t, audit.hasAction(...))` → leave with `//nolint:testifylint` (no better assertion available)
- `assert.True(t, found, "...")` in integration tests → leave as-is (testifylint may not flag these since they have messages)

Evaluate remaining case-by-case after the sed pass.

### 7c. noctx — DB calls without context (22 instances — sed)

**Pattern 1: `db.Exec(` → `db.ExecContext(ctx,` (and variants)**

**Dry run:**
```bash
rg -n '\b(db|writeDB|readDB|metaDB|duckDB|wdb)\.(Exec|QueryRow|Query)\(' --type go --glob '*_test.go'
```

**Bulk replace per file** (add `ctx := context.Background()` where needed):
```bash
# sqlite_test.go has the most (15 instances)
sed -i '' \
  -e 's/writeDB\.Exec(/writeDB.ExecContext(ctx, /g' \
  -e 's/readDB\.QueryRow(/readDB.QueryRowContext(ctx, /g' \
  -e 's/db\.QueryRow(/db.QueryRowContext(ctx, /g' \
  -e 's/db\.Exec(/db.ExecContext(ctx, /g' \
  internal/db/sqlite_test.go

# engine_test.go
sed -i '' 's/metaDB\.Exec(/metaDB.ExecContext(ctx, /g' internal/engine/engine_test.go
sed -i '' 's/db\.Exec(/db.ExecContext(ctx, /g' internal/engine/engine_test.go

# authorization_test.go
sed -i '' 's/db\.Exec(/db.ExecContext(ctx, /g' internal/service/authorization_test.go

# handler_test.go
sed -i '' \
  -e 's/duckDB\.Exec(/duckDB.ExecContext(ctx, /g' \
  -e 's/metaDB\.Exec(/metaDB.ExecContext(ctx, /g' \
  internal/api/handler_test.go

# integration helpers_test.go
sed -i '' 's/duckDB\.Exec(/duckDB.ExecContext(ctx, /g' test/integration/helpers_test.go
```

Add `ctx := context.Background()` to test functions that don't already have it.

**Pattern 2: `http.Get(` / `http.Post(` / `http.NewRequest(` (7 instances — manual)**

These in `internal/api/handler_test.go` need manual conversion to `http.NewRequestWithContext`. Only 7 occurrences, not worth sed.

### 7d. errcheck — `resp.Body.Close()` in tests (146 instances — sed)

**Dry run:**
```bash
rg -c 'resp.*\.Body\.Close\(\)' --type go --glob '*_test.go'  # 146 total across 17 files
```

**Bulk replace:**
```bash
# For deferred closes: add //nolint:errcheck
find . -name '*_test.go' -exec sed -i '' \
  's/defer resp\.Body\.Close()/defer resp.Body.Close() \/\/nolint:errcheck/g' {} +
find . -name '*_test.go' -exec sed -i '' \
  's/defer resp2\.Body\.Close()/defer resp2.Body.Close() \/\/nolint:errcheck/g' {} +
find . -name '*_test.go' -exec sed -i '' \
  's/defer resp3\.Body\.Close()/defer resp3.Body.Close() \/\/nolint:errcheck/g' {} +

# For non-deferred closes (inline): add //nolint:errcheck  
# These patterns vary — check with:
rg -n '^\t+resp\d?\.Body\.Close\(\)$' --type go --glob '*_test.go'
# Then sed each:
find . -name '*_test.go' -exec sed -i '' \
  's/^\(\t*\)resp\.Body\.Close()$/\1resp.Body.Close() \/\/nolint:errcheck/g' {} +
```

### 7e. errcheck — `t.Cleanup(func() { db.Close() })` pattern (sed)

**Dry run:**
```bash
rg -n 'Cleanup.*Close\(\)' --type go --glob '*_test.go'
```

**Bulk replace:**
```bash
find . -name '*_test.go' -exec sed -i '' \
  's/t\.Cleanup(func() { \(.*\)\.Close() })/t.Cleanup(func() { _ = \1.Close() })/g' {} +
```

### 7f. errcheck — test setup calls: `q.GrantPrivilege`, `q.AddGroupMember`, etc. (~35 instances)

**Dry run:**
```bash
rg -n '^\tq\.\(GrantPrivilege\|AddGroupMember\|BindRowFilter\|BindColumnMask\)\(ctx,' --type go --glob '*_test.go'
```

These all discard both return values. Fix by wrapping with error check. Since these are multi-line calls spanning 2-4 lines, sed is fragile — use Edit tool per file.

Pattern: `q.GrantPrivilege(ctx, dbstore.GrantPrivilegeParams{...})` → `_, err = q.GrantPrivilege(ctx, dbstore.GrantPrivilegeParams{...})\nrequire.NoError(t, err)`

### 7g. errcheck — `q.CreatePrincipal` (7 bare calls + 6 `_, _ =` calls)

Bare calls: add `_, err =` + `require.NoError(t, err)`.
`_, _ =` calls: change to `_, err =` + `require.NoError(t, err)`.

### 7h. rowserrcheck in tests — add `rows.Err()` check (6 instances)

**Dry run:**
```bash
rg -n 'for rows\.Next\(\)' --type go --glob '*_test.go'
```
6 instances in 3 test files. Add `require.NoError(t, rows.Err())` after each loop. Manual edits.

### 7i. `defer rows.Close()` in test files (7 instances — sed)

```bash
find . -name '*_test.go' -exec sed -i '' \
  's/defer rows\.Close()/defer rows.Close() \/\/nolint:errcheck/g' {} +
```

---

## Phase 8: Final Verification

```bash
task lint    # expect 0 issues
task test    # ensure no regressions  
task build   # ensure compilation
```

---

## Execution Order

```
Phase 1 (config)     ─┐
Phase 2 (dead code)  ─┤── independent, do first
Phase 5a (rename)    ─┘
         │
Phase 3 (errorlint) → Phase 4 (nilerr)
         │
Phase 5b,c (docs)    ── independent
Phase 6 (prod errcheck) ── independent
Phase 7 (test fixes) ── independent, largest
         │
Phase 8 (verify all)
```

## Sed-able vs Manual Summary

| Category | Count | Method |
|----------|-------|--------|
| `APIHandler` → `Handler` | ~85 | `sed` (one file) |
| `err == sql.ErrNoRows` → `errors.Is` | 10 | `sed` |
| `defer rows.Close()` → nolint | ~27 | `sed` |
| `resp.Body.Close()` → nolint | ~146 | `sed` |
| `assert.True(t, errors.As(...))` → `require.ErrorAs` | 21 | `sed` |
| noctx `db.Exec` → `db.ExecContext` | ~22 | `sed` |
| `t.Cleanup(...Close())` → `_ = ...Close()` | ~15 | `sed` |
| `switch err.(type)` conversions | 33 | Manual (Edit tool) |
| nilerr handler fixes | 5 | Manual (Edit tool) |
| Package doc comments | 13 | Manual (Edit tool) |
| Export doc comments | ~50 | Manual (Edit tool) |
| `main.go` restructure | 1 file | Manual (Edit tool) |
| Test setup calls (`q.GrantPrivilege` etc.) | ~35 | Manual (Edit tool) |

**~326 issues fixable via sed/rg, ~254 require manual edits.**

## Risk Assessment

| Phase | Risk | Mitigation |
|-------|------|------------|
| 2b (`main.go` restructure) | Medium | Extract `run() error`, test manually |
| 3a (33 error switches) | Medium | Follow existing pattern from 3 newer handlers |
| 5a (`APIHandler` rename) | Low | Only in handler.go (verified via `rg`) |
| 7c (noctx sed) | Low | Verify `ctx` variable exists in scope after sed |
| 7d (resp.Body.Close sed) | Low | Dry-run with `rg` first, verify no double nolint |
