# Integration Test Suite Plan

## Goal
Add comprehensive HTTP-level integration tests to `test/integration/` covering ALL 43 API operations. Currently only catalog repo-level tests and DuckDB extension tests exist. The new tests go through the full HTTP stack: auth middleware → API handler → service → repository.

## What's Already Covered
- **catalog_test.go** — Schema/Table CRUD at the repository level (no HTTP, no auth)
- **extension_test.go** — DuckDB C++ extension against real server with S3 (manifest, RLS, column masking, auth errors, audit)

## What's Missing
| Area | Operations | Status |
|------|-----------|--------|
| Auth middleware (JWT + API key) | N/A (cross-cutting) | **No tests** |
| Principals | 5 ops (list, create, get, delete, setAdmin) | **No HTTP tests** |
| Groups | 7 ops (list, create, get, delete, listMembers, addMember, removeMember) | **No HTTP tests** |
| Grants | 3 ops (list, grant, revoke) | **No HTTP tests** |
| Row Filters | 5 ops (list, create, delete, bind, unbind) | **No HTTP tests** |
| Column Masks | 5 ops (list, create, delete, bind, unbind) | **No HTTP tests** |
| Catalog HTTP | 11 ops (getCatalog, schema CRUD, table CRUD, listColumns) | **Repo only, no HTTP** |
| Query Execution | 1 op (executeQuery) | **No HTTP tests** |
| Audit Logs | 1 op (listAuditLogs with filters) | **Only as side-effect in extension tests** |
| Legacy Introspection | 3 ops (listSchemas, listTables, listColumns) | **No HTTP tests** |
| Metastore Summary | 1 op (getMetastoreSummary) | **Repo only, no HTTP** |
| End-to-end RBAC workflow | Cross-resource | **Not tested** |

---

## New Helper: `setupHTTPServer`

Extend `helpers_test.go` with a general-purpose HTTP server setup that does NOT require S3. The existing `setupIntegrationServer` requires S3 credentials; the new helper works with SQLite-only (for RBAC management tests) or SQLite + local DuckLake (for catalog tests).

```
setupHTTPServer(t, opts) → *httpTestEnv

opts:
  - WithDuckLake bool       // wire CatalogService with local DuckLake
  - SeedDuckLakeMetadata bool  // seed ducklake_schema/table/column tables in SQLite
  - JWTSecret []byte        // defaults to "test-jwt-secret"

httpTestEnv:
  - Server *httptest.Server
  - Keys   apiKeys
  - MetaDB *sql.DB          // for direct verification
  - DuckDB *sql.DB          // nil unless WithDuckLake
```

Also add small HTTP helpers:
- `doRequest(t, method, url, apiKey, body) *http.Response` — JSON request with API key
- `decodeJSON[T](t, resp) T` — generic response decoder
- `generateJWT(secret, sub, expiry) string` — create test JWT tokens

---

## New Test Files (by priority)

### P1: `auth_test.go` — Authentication Middleware
**Requires:** SQLite only (no DuckLake, no S3)

| Test | What it verifies |
|------|-----------------|
| `TestAuth_APIKey` | Valid key → 200, invalid key → 401, empty key → 401 |
| `TestAuth_JWT` | Valid token → 200, expired → 401, wrong signature → 401, wrong algo → 401, missing sub → 401 |
| `TestAuth_NoCredentials` | No auth header → 401 with correct JSON body |
| `TestAuth_PrincipalIdentity` | API key and JWT both correctly set the principal in context (verified via audit log or created resource owner) |

### P2: `principals_http_test.go` — Principal CRUD via HTTP
**Requires:** SQLite only

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_PrincipalCRUD` | create → get → list → setAdmin → delete → get returns 404 |
| `TestHTTP_PrincipalErrors` | empty name → 400, duplicate → 409, get nonexistent → 404, delete nonexistent → 404 |
| `TestHTTP_PrincipalPagination` | Create N principals, paginate with max_results + page_token |

### P3: `groups_http_test.go` — Group CRUD + Membership via HTTP
**Requires:** SQLite only

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_GroupCRUD` | create → get → list → delete → get returns 404 |
| `TestHTTP_GroupMembership` | add member → list members → add second → list both → remove → list one |
| `TestHTTP_GroupErrors` | empty name → 400, duplicate → 409, nonexistent group → 404 |

### P4: `grants_http_test.go` — Grant/Revoke via HTTP
**Requires:** SQLite + seeded DuckLake metadata (for securable IDs)

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_GrantRevoke` | grant to user → grant to group → list by principal → list by securable → revoke → list empty |
| `TestHTTP_GrantErrors` | duplicate grant → conflict, revoke nonexistent |

### P5: `row_filters_http_test.go` — Row Filter CRUD + Binding via HTTP
**Requires:** SQLite + seeded DuckLake metadata

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_RowFilterCRUD` | create → list for table → bind → unbind → delete |
| `TestHTTP_RowFilterErrors` | delete nonexistent, bind nonexistent filter |

### P6: `column_masks_http_test.go` — Column Mask CRUD + Binding via HTTP
**Requires:** SQLite + seeded DuckLake metadata

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_ColumnMaskCRUD` | create → list → bind (see_original=false) → bind (see_original=true) → unbind → delete |
| `TestHTTP_ColumnMaskErrors` | delete nonexistent, bind nonexistent mask |

### P7: `audit_http_test.go` — Audit Log Querying via HTTP
**Requires:** SQLite only

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_AuditLogs_Operations` | Perform CRUD ops, then verify audit entries appear with correct action/status |
| `TestHTTP_AuditLogs_Filtering` | Filter by action, principal_name, status |
| `TestHTTP_AuditLogs_Pagination` | Paginate through audit entries |

### P8: `introspection_http_test.go` — Legacy Introspection via HTTP
**Requires:** SQLite + seeded DuckLake metadata

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_Introspection` | list schemas, list tables for schema, list columns for table |

### P9: `catalog_http_test.go` — Catalog Management via HTTP
**Requires:** DuckLake extensions (local filesystem, no S3)

| Test | What it verifies |
|------|-----------------|
| `TestHTTP_CatalogInfo` | GET /v1/catalog returns catalog name |
| `TestHTTP_SchemaCRUD` | create → get → list → update → delete → 404 |
| `TestHTTP_SchemaErrors` | duplicate → 409, invalid name → 400, nonexistent → 404 |
| `TestHTTP_TableCRUD` | create → get → list → listColumns → drop → 404 |
| `TestHTTP_TableErrors` | nonexistent schema → 400, no columns → 400 |
| `TestHTTP_MetastoreSummary` | Verify schema/table counts change after mutations |
| `TestHTTP_CatalogAuthorization` | admin can create/update/delete, unprivileged user gets 403 |

### P10: `rbac_workflow_test.go` — End-to-End RBAC Workflows
**Requires:** SQLite + seeded DuckLake metadata

| Test | What it verifies |
|------|-----------------|
| `TestWorkflow_RBAC_FullCycle` | Create principal → create group → add to group → grant → verify access via list grants → revoke → verify gone |
| `TestWorkflow_GroupInheritance` | User inherits group grants, removing from group loses access |
| `TestWorkflow_RLS_Lifecycle` | Create row filter → bind to group → list filters → verify binding → unbind → delete |
| `TestWorkflow_ColumnMask_Lifecycle` | Create mask → bind with see_original=false → bind different principal with see_original=true → verify bindings → cleanup |

---

## Files to Modify

| File | Change |
|------|--------|
| `test/integration/helpers_test.go` | Add `setupHTTPServer`, `doRequest`, `decodeJSON`, `generateJWT` helpers |
| `test/integration/auth_test.go` | **New** |
| `test/integration/principals_http_test.go` | **New** |
| `test/integration/groups_http_test.go` | **New** |
| `test/integration/grants_http_test.go` | **New** |
| `test/integration/row_filters_http_test.go` | **New** |
| `test/integration/column_masks_http_test.go` | **New** |
| `test/integration/audit_http_test.go` | **New** |
| `test/integration/introspection_http_test.go` | **New** |
| `test/integration/catalog_http_test.go` | **New** |
| `test/integration/rbac_workflow_test.go` | **New** |

---

## Implementation Order

1. **helpers_test.go** — Add `setupHTTPServer` + HTTP helpers (everything depends on this)
2. **auth_test.go** — Security foundation, validates the test setup works
3. **principals_http_test.go** — Simplest CRUD, validates the HTTP test pattern
4. **groups_http_test.go** — Builds on principals pattern, adds membership
5. **grants_http_test.go** — Depends on understanding principal/group IDs
6. **row_filters_http_test.go** — CRUD + binding pattern
7. **column_masks_http_test.go** — Same pattern as row filters
8. **audit_http_test.go** — Verifies audit trail from prior operations
9. **introspection_http_test.go** — Simple read-only tests
10. **catalog_http_test.go** — Requires DuckLake, more complex setup
11. **rbac_workflow_test.go** — Cross-cutting, ties everything together

---

## Conventions

- Build tag: `//go:build integration` on every file
- Package: `package integration`
- Assertions: `require` for fatal, `assert` for non-fatal (testify)
- Table-driven tests with `t.Run()` subtests
- Sequential steps pattern (same as existing catalog tests) for lifecycle tests
- Test names: `TestHTTP_<Area>_<Scenario>` or `TestWorkflow_<Scenario>`
- No S3 required for new tests (except extension_test.go which already exists)
- DuckLake extensions only required for catalog_http_test.go (skip gracefully if unavailable)

---

## Verification

After implementation, run:
```bash
# Compile check (no S3 needed)
go test -tags integration -run XXX_NOMATCH ./test/integration/...

# Run non-DuckLake tests (SQLite-only, no special dependencies)
go test -tags integration -run 'TestAuth|TestHTTP_Principal|TestHTTP_Group|TestHTTP_Grant|TestHTTP_RowFilter|TestHTTP_ColumnMask|TestHTTP_AuditLogs|TestHTTP_Introspection|TestWorkflow' ./test/integration/...

# Run DuckLake-dependent tests (requires ducklake extension)
go test -tags integration -run 'TestHTTP_Catalog|TestHTTP_MetastoreSummary' ./test/integration/...

# Full suite
task integration-test
```
